<apex:page controller="et4ae5.phoenixSendControl" extensions="et4ae5.abTestControl" tabStyle="et4ae5__SendDefinition__c" action="{!abInitialize}" docType="html-5.0">
  <apex:composition template="et4ae5__SendTemplate">
    <apex:define name="customCSS">
      <style>
        .picWrapper {
        display: inline-block;
        vertical-align: bottom;
        background-color: #E98300;
        border-radius: 8px;
        margin-right: 7px;
        }
        .pbBody .abtestselectborder fieldset table {
        width: 100%;
        border-spacing: 25px 5px;
        border-collapse: separate;
        }
        .pbBody .subjectselectborder fieldset table {
        margin-left: auto;
        margin-right: auto;
        border-spacing: 200px 0px;
        border-collapse: separate;
        }
        .pbBody .subjectselectborder fieldset table .emailSubjectButton {
        width: 130px;
        }
        /* Button Style 1 */
        .pbBody .radioselect fieldset table tbody tr td {
        max-width: 125px;
        min-width: 125px;
        text-align: center;
        color: #fef4e9;
        border: solid 1px #da7c0c;
        border-radius: 10px;
        background: #f78d1d;
        background: -webkit-gradient(linear, left top, left bottom, from(#faa51a), to(#EE6B0A));
        background: -moz-linear-gradient(top, #faa51a, #EE6B0A);
        filter: progid: DXImageTransform.Microsoft.gradient(startColorstr='#faa51a', endColorstr='#EE6B0A');
        }
        .pbBody .radioselect fieldset table tbody tr td:hover {
        background: #f4b120;
        background: -webkit-gradient(linear, left top, left bottom, from(#f88e11), to(#f06015));
        background: -moz-linear-gradient(top, #f88e11, #f06015);
        filter: progid: DXImageTransform.Microsoft.gradient(startColorstr='#f88e11', endColorstr='#f06015');
        cursor: pointer;
        cursor: hand;
        }
        .pbBody .radioselect fieldset table tbody tr td label:hover {
        cursor: pointer;
        cursor: hand;
        }
        .pbBody .radioselect fieldset table tbody tr td.abTestSelected {
        color: #fff;
        background: #FCCB7C;
        background: -webkit-gradient(linear, left top, left bottom, from(#FDDFAE), to(#EE6B0A));
        background: -moz-linear-gradient(top, #FDDFAE, #EE6B0A);
        filter: progid: DXImageTransform.Microsoft.gradient(startColorstr='#FDDFAE', endColorstr='#EE6B0A');
        border: solid #009DDC 2px;
        }
        /* General Button Styling */
        .pbBody .radioselect fieldset table tbody tr td label.radioselectoptions {
        font-weight: bold;
        vertical-align: middle;
        }
        .pbBody .radioselect fieldset table tbody tr td input {
        display: none;
        }
        .greytext {
        color: grey;
        }
        /* Slider Styles */
        input[type='range'] {
        -webkit-appearance: none;
        border-radius: 5px;
        box-shadow: inset 0 0 2px #FFF;
        background-color: #FFA100;
        height: 15px;
        width: 100%;
        vertical-align: middle;
        }
        input[type='range']::-moz-range-track {
        -moz-appearance: none;
        border-radius: 5px;
        box-shadow: inset 0 0 2px #FFF;
        background-color: #FFA100;
        height: 15px;
        width: 100%;
        }
        input[type='range']::-webkit-slider-thumb {
        -webkit-appearance: none !important;
        border-radius: 20px;
        background-color: #FFF;
        box-shadow: inset 0 0 10px rgba(233, 131, 000, 0.6);
        border: 1px solid #EA0;
        height: 20px;
        width: 20px;
        }
        input[type='range']::-moz-range-thumb {
        -moz-appearance: none;
        border-radius: 20px;
        background-color: #FFF;
        box-shadow: inset 0 0 10px rgba(233, 131, 000, 0.6);
        border: 1px solid #EA0;
        height: 20px;
        width: 20px;
        }
        //JQuery Slider Styles
        #slider .ui-slider-range {
        background: #FFA100;
        }
        #slider .ui-slider-handle {
        border-color: #FFA100;
        }
        //Subject Styles
        div[id*='abSubjectPanel'] input[type='text'] {
        width: 250px;
        }
        input[name*='emailsubject'] {
        width: 250px;
        }
        input[name*='abEmailSingleSubjectPanel'] {
        width: 250px;
        }
        .popup {
        z-index: 3;
        }
        .ui-widget-header {
        background-image: url({!URLFOR( $Resource.ExactTargetImages, 'sliderBackground.png' )
        }
        );
        background-size:100% 100%;
        }
        .aOrBPicker
        {
        vertical-align: bottom;
        }

      </style>
      <apex:includeScript value="{!URLFOR($Resource.et4ae5__jQueryUI, 'jquery-ui-1.9.2.custom/js/jquery-1.8.3.js')}" />
      <apex:includeScript value="{!URLFOR($Resource.et4ae5__bootstrap, 'dist/js/bootstrap.js')}" />
      <apex:includeScript value="{!URLFOR($Resource.et4ae5__bootstrap, 'dist/js/bootstrap.min.js')}" />
      <apex:includeScript value="{!URLFOR($Resource.et4ae5__jQueryUI, 'jquery-ui-1.9.2.custom/js/jquery-ui-1.9.2.custom.min.js')}" />
      <apex:stylesheet value="{!URLFOR($Resource.et4ae5__jQueryUISlider, 'jquery-ui-1.10.4.custom/css/etSlider/jquery-ui-1.10.4.custom.min.css')}" />
      <script type="text/javascript">
        $(document).ready(function ()
        {
        hideAllAbTest();
        showAbSubject();
        initialize();
        })

        function initialize()
        {
        jQuery("input[value='SUBJECT']").closest("td").addClass("abTestSelected");
        jQuery("input[value='TWOSUBJECTS']").closest("td").addClass("abTestSelected");
        jQuery("input[value='ONESUBJECT']").closest("td").addClass("emailSubjectButton");
        jQuery("input[value='TWOSUBJECTS']").closest("td").addClass("emailSubjectButton");
        jQuery("input[name*='fromSelector']").change(function () { clearFromPicklistValue() });
        jQuery("#fromSelectorIm").on("click", function() { callChangeSendDateTimeType('imm') });
        jQuery("#fromSelectorDT").on("click", function() { callChangeSendDateTimeType('fut') });
        jQuery(".aOrBPicker").on("change", function() { setChosenSingleSubjectEmailSubject() });
        jQuery('#aOrBPicker-A').attr('checked', 'checked');
        jQuery("div[id*='enabledsend']").hide();
        jQuery(document).on("click", ".pbBody .absubjectoptions fieldset table tbody tr td", changeAbSubjectAppearance);
        jQuery(document).on("click", ".pbBody .abtestoptions fieldset table tbody tr td", changeAbTestRadioAppearance);
        jQuery("select[id*='transmissiontype']").on("change", function() { toggleautomaticsendselector(); toggleautomaticsenddate(); });
        jQuery("select[id*='transmissiontype']").val('1');
        jQuery("select[id*='automatictransmissionselection']").on("change", function() { toggleautomaticsenddate(); });
        jQuery("select[id*='automatictransmissionselection']").val("1");
        jQuery("select[id*='automatictransmissionselection']").hide();
        jQuery("input[id*='ScheduledSendRemainderDateTime']").closest("span").hide();
        jQuery(function ()
        {
        jQuery("#slider").slider(
        {
        orientation: "horizontal",
        range: "min",
        max: 100,
        value: 50,
        step: 2,
        slide: function (event, ui)
        {
        setTestPercentage(ui.value);
        jQuery("#testGroup").val(ui.value);
        jQuery("#groupA").val(ui.value / 2);
        jQuery("#groupB").val(ui.value / 2);
        jQuery("#remainder").val(100 - ui.value);
        //Set html values for IE
        jQuery("#testGroup").html(ui.value);
        jQuery("#groupA").html(ui.value / 2);
        jQuery("#groupB").html(ui.value / 2);
        jQuery("#remainder").html(100 - ui.value);
        }
        });
        });
        setFromDefaults();
        setSendDateTimeDefaults();
        }
        function callChangeSendDateTimeType(type) {
        changeSendDateTimeType(type);
        }
        function changeAbTestRadioAppearance(event)
        {
        var target = jQuery(event.target);
        target.find("input").prop('checked', true);
        if (target.text().indexOf("{!$Label.sbjctLn}") > -1)
        {
        showAbSubject();
        }
        if (target.text().indexOf("{!$Label.email}") > -1)
        {
        showAbEmail();
        }
        if (target.text().indexOf("{!$Label.contentArea}") > -1)
        {
        showAbContent();
        }
        if (target.text().indexOf("{!$Label.fromName}") > -1)
        {
        showAbFrom();
        }
        if (target.text().indexOf("{!$Label.sndDSlsT}") > -1)
        {
        showAbDate();
        }
        jQuery(".pbBody .abtestoptions fieldset table tbody tr td").removeClass("abTestSelected");
        target.closest("td").addClass("abTestSelected");
        }

        function toggleautomaticsendselector()
        {
        if (jQuery("select[id*='transmissiontype']").val() == 1)
        {
        jQuery("select[id*='automatictransmissionselection']").hide();
        jQuery("select[id*='automatictransmissionselection']").val("1");
        }
        else
        {
        jQuery("select[id*='automatictransmissionselection']").show();
        }
        }

        function toggleautomaticsenddate()
        {
        if (jQuery("select[id*='automatictransmissionselection']").val() == 1)
        {
        jQuery("input[id*='ScheduledSendRemainderDateTime']").closest("span").hide();
        }
        else
        {
        jQuery("input[id*='ScheduledSendRemainderDateTime']").closest("span").show();
        }
        }

        function showAbSubject()
        {
        hideAllAbTest();
        clearSubjectLines();
        jQuery("[id*='abSubjectPanel']").closest('tr').show();
        jQuery("[id*='emailTemplate']").closest('tr').show();
        jQuery("[id*='selectedFrom']").closest('tr').show();
        jQuery("[id*='sendDateTimeRadios']").closest('tr').show();
        jQuery("div[id*='saveWinningTest']").show();
        jQuery(".dataCol.first.last.subjectB").find("input:first-child").prop("disabled", false);
        jQuery(".aOrBPicker").closest('div').hide();
        changeTestTypePageReset();
        }

        function showAbEmail()
        {
        hideAllAbTest();
        clearSubjectLines();
        jQuery("[id*='abEmailPanel']").closest('tr').show();
        jQuery("[id*='absubjectbuttons']").closest('tr').show();
        jQuery("[id*='abSubjectPanel']").closest('tr').show();
        jQuery("[id*='selectedFrom']").closest('tr').show();
        jQuery("[id*='sendDateTimeRadios']").closest('tr').show();
        if (jQuery("input[value='ONESUBJECT']").prop("checked"))
        {
        showOneSubject();
        }
        else
        {
        showTwoSubjects();
        }
        changeTestTypePageReset();
        }

        function showAbContent()
        {
        hideAllAbTest();
        clearSubjectLines();
        jQuery("[id*='emailTemplate']").closest('tr').show();
        jQuery("[id*='selectedFrom']").closest('tr').show();
        jQuery("[id*='sendDateTimeRadios']").closest('tr').show();
        jQuery("[id*='emailsubject']").closest('tr').show();
        jQuery("[id*='abContentAreaInfo']").closest('tr').show();
        changeTestTypePageReset();
        }

        function showAbFrom()
        {
        hideAllAbTest();
        clearSubjectLines();
        jQuery("[id*='emailTemplate']").closest('tr').show();
        jQuery("[id*='abFromNamePanel']").closest('tr').show();
        jQuery("[id*='sendDateTimeRadios']").closest('tr').show();
        jQuery("[id*='emailsubject']").closest('tr').show();
        changeTestTypePageReset();
        }

        function showAbDate()
        {
        hideAllAbTest();
        clearSubjectLines();
        jQuery("[id*='emailTemplate']").closest('tr').show();
        jQuery("[id*='abSendDateTimePanel']").closest('tr').show();
        jQuery("[id*='selectedFrom']").closest('tr').show();
        jQuery("[id*='emailsubject']").closest('tr').show();
        jQuery('[id$=idFromSelectorDTA]').show();
        jQuery('[id$=idFromSelectorDTB]').show();
        changeTestTypePageReset();
        }

        function hideAllAbTest()
        {
        jQuery("[id*='abSubjectPanel']").closest('tr').hide();
        jQuery("[id*='abEmailSingleSubjectPanel']").closest('tr').hide();
        jQuery("[id*='EmailPreviewSingle']").closest('tr').hide();
        jQuery("[id*='absubjectbuttons']").closest('tr').hide();
        jQuery("[id*='emailTemplate']").closest('tr').hide();
        jQuery("[id*='abEmailPanel']").closest('tr').hide();
        jQuery("[id*='abFromNamePanel']").closest('tr').hide();
        jQuery("[id*='abSendDateTimePanel']").closest('tr').hide();
        jQuery("[id*='emailsubject']").closest('tr').hide();
        jQuery("[id*='selectedFrom']").closest('tr').hide();
        jQuery("[id*='sendDateTimeRadios']").closest('tr').hide();
        jQuery("[id*='abContentAreaInfo']").closest('tr').hide();
        jQuery("div[id*='saveWinningTest']").hide();
        }

        function clearSubjectLines()
        {
        jQuery("input[name*='emailSubectSingleText']").val('');
        jQuery("input[name*='abEmailSingleSubject']").val('');
        jQuery("input[name*='emailsubjecta']").val('');
        jQuery("input[name*='emailsubjectb']").val('');
        }

        function changeAbSubjectAppearance(event)
        {
        var target = jQuery(event.target);
        target.find("input").prop('checked', true);
        if (target.text().indexOf('Use one subject line') > -1)
        {
        showOneSubject();
        }
        if (target.text().indexOf('Use two subject lines') > -1)
        {
        showTwoSubjects();
        }
        jQuery(".pbBody .absubjectoptions fieldset table tbody tr td").removeClass("abTestSelected");
        target.closest("td").addClass("abTestSelected");
        }

        function showOneSubject()
        {
        jQuery(".aOrBPicker").closest('div').show();
        if(jQuery('#aOrBPicker-A').attr('checked') === 'checked')
        {
        jQuery('input[name*="emailsubjecta"]').attr('disabled',false);
        jQuery('input[name*="emailsubjectb"]').attr('disabled',true);
        }
        else
        {
        jQuery('input[name*="emailsubjecta"]').attr('disabled',true);
        jQuery('input[name*="emailsubjectb"]').attr('disabled',false);
        }
        }

        function showTwoSubjects()
        {
        jQuery(".aOrBPicker").closest('div').hide();
        jQuery('input[name*="emailsubjecta"]').attr('disabled',false);
        jQuery('input[name*="emailsubjectb"]').attr('disabled',false);
        }
        //From Test Functions
        function setFromDefaults()
        {
        jQuery("#fromSelectorEmailA").prop('checked', true);
        jQuery("#fromSelectorEmailB").prop('checked', true);
        jQuery("#fromSelectorEmail").prop('checked', true);
        }
        //Send Date/Time Functions
        function setSendDateTimeDefaults()
        {
        jQuery("#fromSelectorImA").prop('checked', true);
        jQuery("#fromSelectorDTB").prop('checked', true);
        jQuery("#fromSelectorIm").prop('checked', true);
        }

        function clearFromPicklistValue()
        {
        if (jQuery("#fromSelectorEmail").prop('checked'))
        {
        jQuery("select[id*='sendClassificationSingle']").val("");
        }
        else
        {
        jQuery("select[id*='fromSingle']").val("");
        }
        }
        function callSetTestPercentage()
        {
        var testp = jQuery("#testGroup").val();
        if (testp === '')
        {
        testp = jQuery("#testGroup").html();
        }
        setTestPercentage(testp);
        }
        function setSingleEmailTitle(emailSubject)
        {
        emailSubject = uriDecodeSubject(emailSubject);
        jQuery("input[name*='emailSubectSingleText']").val(emailSubject);
        jQuery("input[name*='abEmailSingleSubject']").val(emailSubject);
        jQuery("input[name*='emailsubjecta']").val(emailSubject);
        }
        function setEmailATitle(emailSubject)
        {
        emailSubject = uriDecodeSubject(emailSubject);
        jQuery("input[name*='abEmailSingleSubject']").val(emailSubject);
        jQuery("input[name*='emailsubjecta']").val(emailSubject);
        }
        function setEmailBTitle(emailSubject)
        {
        emailSubject = uriDecodeSubject(emailSubject);
        jQuery("input[name*='emailsubjectb']").val(emailSubject);
        }
        function uriDecodeSubject(subject)
        {
        subject = subject.replace(/\+/g,' ');
        subject = decodeURIComponent(subject);
        subject = subject.replace(/\\\"/g, "\"");
        return subject;
        }
        // This function calls an action function that sets a controller field (selectSubjectAorB)
        // to A or B depending on which radio button is selected when choosing to do an email test
        // with only one subject.
        function setChosenSingleSubjectEmailSubject()
        {
        if(jQuery('#aOrBPicker-A').attr('checked') === 'checked')
        {
        setSelectSubjectAorB('A');
        jQuery('input[name*="emailsubjectb"]').attr('disabled',true);
        jQuery('input[name*="emailsubjecta"]').attr('disabled',false);
        }
        else
        {
        setSelectSubjectAorB('B');
        jQuery('input[name*="emailsubjectb"]').attr('disabled',false);
        jQuery('input[name*="emailsubjecta"]').attr('disabled',true);
        }
        }
      </script>
    </apex:define>
    <apex:define name="sendTypeImage">
      <div class="picWrapper">
        <img style="height:45px;" src="{!URLFOR( $Resource.ExactTargetImages, 'custom90.svg' )}" />
      </div>
    </apex:define>
    <apex:define name="buManagementImage">
      <img height="45" src="{!URLFOR( $Resource.ExactTargetImages, 'bumgmtemail.png' )}" />
    </apex:define>
    <apex:define name="sendTypeLabel">
      {!$Label.etAbTest}
    </apex:define>
  </apex:composition>
  <apex:form styleClass="fieldForm">
    <apex:actionFunction name="setSelectSubjectAorB" rerender="">
      <apex:param name="aOrBChosen" value="" assignTo="{!selectSubjectAorB}" />
    </apex:actionFunction>
    <apex:actionFunction name="setTestPercentage" action="{!setTestPercentage}" rerender="sendbutton">
      <apex:param name="testPercent" value="" assignTo="{!testGroupPercent}" />
    </apex:actionFunction>
    <apex:actionFunction name="populateABContent" action="{!populateABContent}" rerender="emailName,exactTargetEmails,recipientReportWrapper,sendEmailForm,listChoosers,abContentAreaInfo,emailPreviewLinkWrapper">
      <apex:param name="emailId" value="" />
      <apex:param name="emailName" value="" />
      <apex:param name="emailSubject" value="" />
      <apex:param name="test" value="" />
    </apex:actionFunction>
    <apex:actionFunction name="selectEmailJSA" action="{!selectEmailAB}" onComplete="setSyncRequest({!syncPayload});" rerender="abEmailPanel,emailAName,exactTargetEmailsA,emailAPreviewLinkWrapper,recipientReportWrapper,sendEmailForm,listChoosers"
    status="listEmailsStatusA">
      <apex:param name="emailId" value="" />
      <apex:param name="emailName" value="" />
      <apex:param name="emailSubject" value="" />
      <apex:param name="test" value="" />
    </apex:actionFunction>
    <apex:actionFunction name="selectEmailJSB" action="{!selectEmailAB}" onComplete="setSyncRequest({!syncPayload});" rerender="abEmailPanel,emailBName,exactTargetEmailsB,emailBPreviewLinkWrapper,recipientReportWrapper,sendEmailForm,listChoosers"
    status="listEmailsStatusB">
      <apex:param name="emailId" value="" />
      <apex:param name="emailName" value="" />
      <apex:param name="emailSubject" value="" />
      <apex:param name="test" value="" />
    </apex:actionFunction>
    <apex:actionFunction name="changeTestTypePageReset" action="{!changeTestTypePageReset}" onComplete="setSyncRequest({!syncPayload});"
    rerender="abContentAreaInfo,emailName,emailAName,emailBName,exactTargetEmails,exactTargetEmailsA,exactTargetEmailsB,emailPreviewLinkWrapper,emailAPreviewLinkWrapper,emailBPreviewLinkWrapper,recipientReportWrapper,sendEmailForm,listChoosers"
    status="PageResetStatus">
    </apex:actionFunction>
    <apex:actionFunction name="selectReportJS" action="{!selectReport}" rerender="emailName,exactTargetEmails,recipientReportWrapper,sendEmailForm,recipientReportsZ,recipSourcePicklists,listChoosers"
    status="listRecipientReportsStatus">
      <apex:param name="ReportId" value="" />
      <apex:param name="ReportName" value="" />
    </apex:actionFunction>
    <apex:actionFunction name="selectExcluReportJS" action="{!selectExcluReport}" rerender="emailName,exactTargetEmails,recipientReportWrapper,sendEmailForm,recipientReportsZ,recipSourcePicklists,listChoosers"
    status="listRecipientReportsStatus">
      <apex:param name="ReportId" value="" />
      <apex:param name="ReportName" value="" />
    </apex:actionFunction>
    <apex:actionFunction name="selectExclusionReportJS" action="{!selectExclusionReport}" rerender="emailName,exactTargetEmails,exclusionReportWrapper,sendEmailForm"
    status="listExclusionReportsStatus">
      <apex:param name="ExclusionReportId" value="" />
      <apex:param name="ExclusionReportName" value="" />
    </apex:actionFunction>
    <apex:actionFunction name="getFolderInfo" action="{!expandFolderGeneral}" rerender="absubjectpanel,pageMessages,emailName,exactTargetEmails,recipientReportWrapper" status="listEmailsStatus">
      <apex:param name="folderId" value="" />
      <apex:param name="sdl" value="" />
    </apex:actionFunction>
    <apex:actionFunction name="getFolderInfoA" action="{!expandFolderGeneral}" rerender="absubjectpanel,pageMessages,emailAName,emailASubject,exactTargetEmailsA,emailAPreviewLinkWrapper,recipientReportWrapper"
    status="listEmailsStatusA">
      <apex:param name="folderId" value="" />
      <apex:param name="sdl" value="" />
    </apex:actionFunction>
    <apex:actionFunction name="getFolderInfoB" action="{!expandFolderGeneral}" rerender="absubjectpanel,pageMessages,emailBName,exactTargetEmailsB,emailBPreviewLinkWrapper,recipientReportWrapper"
    status="listEmailsStatusB">
      <apex:param name="folderId" value="" />
      <apex:param name="sdl" value="" />
    </apex:actionFunction>
    <apex:actionFunction name="openReportFolder" action="{!expandReportFolder}" rerender="pageMessages,emailName,exactTargetEmails,recipientReportWrapper,recipientReportsZ"
    status="listRecipientReportsStatus">
      <apex:param name="reportFolderId" value="" />
    </apex:actionFunction>
    <apex:actionFunction name="openExcluReportFolder" action="{!expandReportFolder}" rerender="pageMessages,emailName,exactTargetEmails,recipientReportWrapper,recipientReportsZ,listChoosers"
    status="listRecipientReportsStatus">
      <apex:param name="reportFolderId" value="" />
    </apex:actionFunction>
    <apex:actionFunction name="toggleSort" action="{!toggleSort}" rerender="results">
      <apex:param name="tsSortField" value="" />
    </apex:actionFunction>
    <apex:actionFunction name="openExclusionReportFolder" action="{!expandExclusionReportFolder}" rerender="emailName,exactTargetEmails,exclusionReportWrapper" status="listExclusionReportsStatus">
      <apex:param name="exclusionReportFolderId" value="" />
    </apex:actionFunction>
    <apex:actionFunction name="openSubscriberListFolder" action="{!expandSubscriberListFolder}" rerender="emailName,exactTargetEmails,subscriberListWrapper" status="listSubscriberListsStatus">
      <apex:param name="subscriberListFolderId" value="" />
    </apex:actionFunction>
    <apex:actionFunction name="inclusionAdd" action="{!inclusionAdd}" onComplete="setSyncRequest({!syncPayload});" rerender="sendEmailForm,emailWrapper,emailName,exactTargetEmails,subscriberListWrapper,inclusionCampaignsZ,recipientReportsZ,listChoosers"
    status="recipPicklistStatus" />
    <apex:actionFunction name="inclusionRemove" action="{!removeCampaignList}" onComplete="setSyncRequest({!syncPayload});" rerender="sendEmailForm,emailName,exactTargetEmails,subscriberListWrapper,inclusionCampaignsZ,recipSourcePicklists,listChoosers"
    status="removeRecipientStatus">
      <apex:param name="removeCampaignListId" value="" />
    </apex:actionFunction>
    <apex:actionFunction name="exclusionAdd" action="{!exclusionAdd}" onComplete="setSyncRequest({!syncPayload});" rerender="sendEmailForm,emailWrapper,emailName,exactTargetEmails,subscriberListWrapper,inclusionCampaignsZ,recipientReportsZ,listChoosers"
        />
    <apex:actionFunction name="exclusionRemove" action="{!removeExcluCampaignList}" onComplete="setSyncRequest({!syncPayload});" rerender="emailName,exactTargetEmails,subscriberListWrapper,inclusionCampaignsZ,recipSourcePicklists,listChoosers">
      <apex:param name="removeCampaignListId" value="" />
    </apex:actionFunction>
    <apex:actionFunction name="selectLuBu" action="{!selectLuBu}" onComplete="hidepopup();" rerender="TestManagementTop,exactTargetEmails,pageMessages,sendEmailForm,fromBlock,recipientReports,recipientReportsZ,exclusionReports,exclusionReportsZ"
    status="wholePageBlock">
      <apex:param name="luBuId" value="" />
    </apex:actionFunction>
    <apex:actionFunction name="checkSendEmailReadiness" action="{!sendEnabler}" rerender="" />
    <apex:actionFunction name="isSSon" action="{!isSSon}" rerender="" />
    <apex:actionFunction name="isSSoff" action="{!isSSoff}" rerender="" />
    <apex:actionFunction name="createBuFilter" action="{!createBuFilter}" oncomplete="showpopup();" status="wholePageBlock" rerender="TestManagementTop,popupOP,exactTargetEmails,pageMessages,sendEmailForm,fromBlock,recipientReports,recipientReportsZ,exclusionReports,exclusionReportsZ"
        />
    <apex:actionFunction name="refreshPopup" action="{!voidReturn}" rerender="popupOP,opaqueOP" />
    <apex:stylesheet value="{!$Resource.et4ae5__ExactTargetStyles}" />
    <apex:actionFunction name="changeSendDateTimeType" action="{!changeSendDateTimeType}" rerender="none" >
      <apex:param name="selectedSendDateTimeOption" value="" />
    </apex:actionFunction>
    <apex:actionFunction name="setSendImmediately" action="{!setSendImmediately}" rerender="none" />
    <apex:actionFunction name="setSendFuture" action="{!setSendFuture}" rerender="none" />
    <apex:actionFunction name="searchServer" action="{!runFolderSearch}" rerender="foldersReturned,pageMessages">
      <apex:param name="folderSearch" value=""/>
    </apex:actionFunction>
    <apex:actionFunction name="searchServerExc" action="{!runFolderSearch}" rerender="foldersReturnedExc,pageMessages">
      <apex:param name="folderSearchExc" value=""/>
    </apex:actionFunction>
    <div align="right">
      <apex:outputpanel >
        <apex:outputLink target="_blank" style="text-decoration:none;color:#015ba7;" value="{!etLink}sessurl={!$Api.Partner_Server_URL_140}&sessid={!$Api.Session_ID}" onMouseOver="this.style.textDecoration='underline'" onMouseOut="this.style.textDecoration='none'">
          {!$Label.goToEt}
        </apex:outputLink>
        <apex:outputText rendered="{!hasMobile}" value="{!pipe}" />
        <apex:commandLink rendered="{!hasMobile}" style="text-decoration:none;color:#015ba7;" value="{!$Label.mobileSend}" onMouseOver="this.style.textDecoration='underline'"
        onMouseOut="this.style.textDecoration='none'" action="{!goToMobile}" />
        <apex:outputText value="{!pipe}" rendered="{!hasTriggered}"/>
        <apex:commandLink style="text-decoration:none;color:#015ba7;" value="{!$Label.sendAtmtn}" onMouseOver="this.style.textDecoration='underline'" onMouseOut="this.style.textDecoration='none'"
                action="{!goToTriggeredSends}" rendered="{!hasTriggered}"/>
        <apex:outputText rendered="{!isAdmin}" value="{!isAdminPipe}" />
        <apex:commandLink rendered="{!isAdmin}" style="text-decoration:none;color:#015ba7;" value="{!$Label.configInt}" onMouseOver="this.style.textDecoration='underline'"
        onMouseOut="this.style.textDecoration='none'" action="{!goToSettings}" />&nbsp;&nbsp;&nbsp;
      </apex:outputpanel>
    </div>
    <br />
    <apex:outputPanel id="pageMessages">
      <c:pageMessages closableErrors="true" />
    </apex:outputPanel>
    <apex:actionStatus id="wholePageBlock">
      <apex:facet name="start">
        <img class="spinnerLarge" src="{!URLFOR( $Resource.ExactTargetImages, 'spinEMAIL.GIF' )}" />
      </apex:facet>
      <apex:facet name="stop">
        <apex:pageBlock mode="view">
          <!-- Apex Radio Buttons -->
          <apex:outputPanel styleClass="abtestselectborder radioselect abtestoptions">
            <apex:selectRadio enabledClass="radioselectoptions" value="{!abTestOption}">
              <apex:selectOptions value="{!AbTestOptions}" />
            </apex:selectRadio>
          </apex:outputPanel>
          <hr color="#FFA100" />
          <div style="font-size: 14px; color: #4f4f4f; font-family: 'Helvetica', 'Arial', sans-serif; font-weight: bold;">
            Test Management
          </div>

          <div align="right">
            <img style="vertical-align: middle;" height="18px" src="{!URLFOR( $Resource.ExactTargetImages, 'reqEmail.png' )}" />
            <b> = {!$label.reqdInfo} </b>
          </div>
          <hr color="#ececec" />
          <apex:pageBlockSection columns="1" id="TestManagementTop">
            <!-- Details -->
            <apex:pageBlockSectionItem helpText="{!$Label.abNameHelp}">
              <apex:outputLabel value="{!$Label.name}" />
              <apex:outputPanel >
                <apex:inputText id="ABTestName" value="{!abName}" />
                <img style="vertical-align: middle;" height="18px" src="{!URLFOR( $Resource.ExactTargetImages, 'reqEmail.png' )}" />
              </apex:outputPanel>
            </apex:pageBlockSectionItem>
            <!-- Label -->
            <apex:pageBlockSectionItem helpText="{!$Label.abDescriptionHelp}">
              <apex:outputLabel value="{!$Label.description}" />
              <apex:inputText id="ABTestDescription" value="{!abDescription}" />
            </apex:pageBlockSectionItem>
            <!-- Business Unit -->
            <apex:pageBlockSectionItem rendered="{!renderBULookup}" helpText="{!$Label.abMrkCloudBUHelp}">
              <apex:outputLabel value="{!$Label.busUnit}" />
              <apex:outputPanel >
                <table>
                  <tr>
                    <td>
                      <apex:outputText id="selectedBU" value="{!selectedBuDisp}" />
                    </td>
                    <td>
                      <input type="image" onclick="javascript:createBuFilter();return false;" src="/s.gif" id="showPopBtn" />
                    </td>
                    <td>
                      <img style="vertical-align: middle;" height="18px" src="{!URLFOR( $Resource.ExactTargetImages, 'reqEmail.png' )}" />
                    </td>
                  </tr>
                </table>
              </apex:outputPanel>
            </apex:pageBlockSectionItem>
          </apex:pageBlockSection>
          <apex:pageBlockSection columns="1" id="TestManagementBottom">
            <!-- Email -->
            <apex:pageBlockSectionItem id="emailTemplate" helpText="{!$Label.abEmailHelp}">
              <apex:outputLabel for="emailName" value="{!$Label.email}" />
              <apex:outputPanel id="emailWrapper" layout="block">
                <apex:outputText id="emailName" value="{!localSend.email.name}" />
                <apex:outputPanel id="emailPreviewLinkWrapper">
                  <!-- emailPreviewLink panel used to house rerendering of Edit Email. Email preview to come in the future -->
                  <apex:outputPanel id="emailPreviewLink" rendered="{!IF( NOT( ISNULL( localSend.email ) ), true, false )}">
                    <apex:actionStatus id="previewEmailStatus">
                      <apex:facet name="start">
                        <img class="spinnerLarge" src="{!URLFOR( $Resource.ExactTargetImages, 'spinEMAIL.GIF' )}" />
                      </apex:facet>
                      <apex:facet name="stop">
                        <apex:outputpanel >
                          <apex:outputLink target="_blank" style="padding-right:10px;padding-left:10px;" value="{!etLink}sessurl={!$Api.Partner_Server_URL_140}&sessid={!$Api.Session_ID}&entityType=Email&displaynavi=false&entityid={!localsend.email.id}">
                            <!--<apex:outputLink target="_blank" style="padding-right:10px;padding-left:10px;" value="{!etLink}sessurl={!$Api.Partner_Server_URL_140}&sessid={!$Api.Session_ID}&entityType=Email&displaynavi=false&entityid={!selectedemail}">-->
                            {!$Label.editEml}
                          </apex:outputLink>
                        </apex:outputpanel>
                      </apex:facet>
                    </apex:actionStatus>
                  </apex:outputPanel>
                </apex:outputPanel>
                <apex:outputPanel >
                  <apex:actionStatus id="listEmailsStatus">
                    <apex:facet name="start">
                      <img class="spinnerLarge" src="{!URLFOR( $Resource.ExactTargetImages, 'spinEMAIL.GIF' )}" />
                    </apex:facet>
                    <apex:facet name="stop">
                      <apex:commandButton id="listEmails" value="{!$Label.find}" action="{!listExactTargetEmails}" rerender="exactTargetEmails,pageMessages,sendEmailForm,recipientReports,recipientReportsZ,exclusionReports,exclusionReportsZ"
                      status="listEmailsStatus" />
                    </apex:facet>
                  </apex:actionStatus>
                  <apex:outputText value="{!pipe}"/>
                  <apex:outputLink target="_blank" style="padding-right:10px;" value="{!etLink}sessurl={!$Api.Partner_Server_URL_140}&sessid={!$Api.Session_ID}&entityType=Email&displaynavi=false&entityid=&entityAction=Create">
                    {!$Label.new}
                  </apex:outputLink>
                  <img style="vertical-align: middle;" height="18px" src="{!URLFOR( $Resource.ExactTargetImages, 'reqEmail.png' )}" />
                  <apex:outputPanel id="exactTargetEmails" layout="block">
                    <apex:actionStatus id="clickEmailStatus">
                      <apex:facet name="start">
                        <img class="spinnerLarge" src="{!URLFOR( $Resource.ExactTargetImages, 'spinEMAIL.GIF' )}" />
                      </apex:facet>
                      <apex:facet name="stop">
                        <apex:outputPanel styleClass="popup" layout="block" rendered="{!ShowEmailChooser }">
                          <script type="text/javascript">
                            function toggleFolderDisplay(folderId)
                            {
                            // Identify folder div.
                            var folderDiv = document.getElementById(folderId);

                            // Pull the folder class.
                            var folderClass = folderDiv.className;

                            // Determine if the folder is open or closed.
                            var newFolderClass = 'emailFolder closed';
                            if (folderClass.indexOf('closed') > -1)
                            {
                            newFolderClass = 'emailFolder open';
                            }

                            // Assing new class.
                            folderDiv.className = newFolderClass;
                            }
                          </script>
                          <apex:pageBlock >
                            <apex:pageBlockButtons location="both">
                              <apex:commandButton action="{!selectEmailCancel}" value="{!$Label.cancel}" rerender="exactTargetEmails" status="clickEmailStatus" />
                            </apex:pageBlockButtons>
                            <apex:repeat value="{!localSend.emails}" var="emailFolder1">
                              +
                              <a href="#" onclick="javascript:getFolderInfo('{!emailFolder1.Id}', 'pscLocalsend'); javascript:toggleFolderDisplay( 'emailFolder_{!emailFolder1.Id}' )">
                                <b> {!emailFolder1.name} </b>
                              </a>
                              <br />
                              <div class="emailFolder closed" id="emailFolder_{!emailFolder1.Id}">
                                <apex:repeat value="{!emailFolder1.subfolders}" var="emailFolder2" rendered="{!NOT( ISBLANK( emailFolder1.subfolders ) )}">
                                  +
                                  <a href="#" onclick="javascript:getFolderInfo('{!emailFolder2.Id}', 'pscLocalsend'); javascript:toggleFolderDisplay( 'emailFolder_{!emailFolder2.Id}' )">
                                    <b> {!emailFolder2.name} </b>
                                  </a>
                                  <br />
                                  <div class="emailFolder closed" id="emailFolder_{!emailFolder2.Id}">
                                    <apex:repeat value="{!emailFolder2.subfolders}" var="emailFolder3" rendered="{!NOT( ISBLANK( emailFolder2.subfolders ) )}">
                                      +
                                      <a href="#" onclick="javascript:getFolderInfo('{!emailFolder3.Id}', 'pscLocalsend'); javascript:toggleFolderDisplay( 'emailFolder_{!emailFolder3.Id}' )">
                                        <b> {!emailFolder3.name} </b>
                                      </a>
                                      <br />
                                      <div class="emailFolder closed" id="emailFolder_{!emailFolder3.Id}">
                                        <apex:repeat value="{!emailFolder3.subfolders}" var="emailFolder4" rendered="{!NOT( ISBLANK( emailFolder3.subfolders ) )}">
                                          +
                                          <a href="#" onclick="javascript:getFolderInfo('{!emailFolder4.Id}', 'pscLocalsend'); javascript:toggleFolderDisplay( 'emailFolder_{!emailFolder4.Id}' )">
                                            <b> {!emailFolder4.name} </b>
                                          </a>
                                          <br />
                                          <div class="emailFolder closed" id="emailFolder_{!emailFolder4.Id}">
                                            <apex:repeat value="{!emailFolder4.subfolders}" var="emailFolder5" rendered="{!NOT( ISBLANK( emailFolder4.subfolders ) )}">
                                              +
                                              <a href="#" onclick="javascript:getFolderInfo('{!emailFolder5.Id}', 'pscLocalsend'); javascript:toggleFolderDisplay( 'emailFolder_{!emailFolder5.Id}' )">
                                                <b> {!emailFolder5.name} </b>
                                              </a>
                                              <br />
                                              <div class="emailFolder closed" id="emailFolder_{!emailFolder5.Id}">
                                                <apex:repeat value="{!emailFolder5.emails}" var="email5">
                                                  &nbsp;-&nbsp;
                                                  <a href="#" onclick="javascript:populateABContent( '{!email5.id}', uriDecodeSubject('{!email5.encName}'), '{!email5.encTitle}', '' ); setSingleEmailTitle('{!email5.encTitle}'); /*subscriberPreview.setEmailId('{!email5.id}');*/" status="sendButtonStatus">
                                                    {!email5.name}
                                                  </a>
                                                  <br />
                                                </apex:repeat>
                                              </div>
                                            </apex:repeat>
                                            <apex:repeat value="{!emailFolder4.emails}" var="email4">
                                              &nbsp;-&nbsp;
                                              <a href="#" onclick="javascript:populateABContent( '{!email4.id}', uriDecodeSubject('{!email4.encName}'), '{!email4.encTitle}', '' ); setSingleEmailTitle('{!email4.encTitle}'); /*subscriberPreview.setEmailId('{!email4.id}');*/" status="sendButtonStatus"> {!email4.name} </a>
                                              <br />
                                            </apex:repeat>
                                          </div>
                                        </apex:repeat>
                                        <apex:repeat value="{!emailFolder3.emails}" var="email3">
                                          &nbsp;-&nbsp;
                                          <a href="#" onclick="javascript:populateABContent( '{!email3.id}', uriDecodeSubject('{!email3.encName}'), '{!email3.encTitle}', '' ); setSingleEmailTitle('{!email3.encTitle}'); /*subscriberPreview.setEmailId('{!email3.id}');*/" status="sendButtonStatus"> {!email3.name} </a>
                                          <br />
                                        </apex:repeat>
                                      </div>
                                    </apex:repeat>
                                    <apex:repeat value="{!emailFolder2.emails}" var="email2">
                                      &nbsp;-&nbsp;
                                      <a href="#" onclick="javascript:populateABContent( '{!email2.id}', uriDecodeSubject('{!email2.encName}'), '{!email2.encTitle}', '' ); setSingleEmailTitle('{!email2.encTitle}'); /*subscriberPreview.setEmailId('{!email2.id}');*/" status="sendButtonStatus"> {!email2.name} </a>
                                      <br />
                                    </apex:repeat>
                                  </div>
                                </apex:repeat>
                                <apex:repeat value="{!emailFolder1.emails}" var="email1">
                                  &nbsp;-&nbsp;
                                  <a href="#" onclick="javascript:populateABContent( '{!email1.id}', uriDecodeSubject('{!email1.encName}'), '{!email1.encTitle}', '' ); setSingleEmailTitle('{!email1.encTitle}'); /*subscriberPreview.setEmailId('{!email1.id}');*/" status="sendButtonStatus"> {!email1.name} </a>
                                  <br />
                                </apex:repeat>
                              </div>
                            </apex:repeat>
                          </apex:pageBlock>
                        </apex:outputPanel>
                      </apex:facet>
                    </apex:actionStatus>
                  </apex:outputPanel>
                </apex:outputPanel>
              </apex:outputPanel>
            </apex:pageBlockSectionItem>
            <!-- Email A -->
            <apex:pageBlockSection id="abEmailPanel">
              <apex:pageBlockSectionItem id="emailATemplate" helpText="{!$Label.abEmailHelp}">
                <apex:outputLabel for="emailAName" value="{!$Label.email_A}" />
                <apex:outputPanel id="emailAWrapper" layout="block">
                  <apex:outputText id="emailAName" value="{!localSendA.email.name}" />
                  <apex:outputPanel id="emailAPreviewLinkWrapper">
                    <!-- emailPreviewLink panel used to house rerendering of Edit Email. Email preview to come in the future -->
                    <apex:outputPanel id="emailAPreviewLink" rendered="{!IF( NOT( ISNULL( localSendA.email.id ) ), true, false )}">
                      <apex:actionStatus id="previewEmailAStatus">
                        <apex:facet name="start">
                          <img class="spinnerLarge" src="{!URLFOR( $Resource.ExactTargetImages, 'spinEMAIL.GIF' )}" />
                        </apex:facet>
                        <apex:facet name="stop">
                          <apex:outputpanel >
                            <apex:outputLink target="_blank" style="padding-right:10px;padding-left:10px;" value="{!etLink}sessurl={!$Api.Partner_Server_URL_140}&sessid={!$Api.Session_ID}&entityType=Email&displaynavi=false&entityid={!localSendA.email.id}">
                              {!$Label.editEml}
                            </apex:outputLink>
                          </apex:outputpanel>
                        </apex:facet>
                      </apex:actionStatus>
                    </apex:outputPanel>
                  </apex:outputPanel>
                  <apex:outputPanel >
                    <apex:actionStatus id="listEmailsStatusA">
                      <apex:facet name="start">
                        <img class="spinnerLarge" src="{!URLFOR( $Resource.ExactTargetImages, 'spinEMAIL.GIF' )}" />
                      </apex:facet>
                      <apex:facet name="stop">
                        <apex:commandButton id="listEmailsA" value="{!$Label.find}" action="{!listExactTargetEmailsA}" rerender="exactTargetEmailsA,pageMessages,sendEmailForm,recipientReports,recipientReportsZ,exclusionReports,exclusionReportsZ"
                        status="listEmailsStatusA" />
                      </apex:facet>
                    </apex:actionStatus>
                    <apex:outputText value="{!pipe}"/>
                    <apex:outputLink target="_blank" style="padding-right:10px;" value="{!etLink}sessurl={!$Api.Partner_Server_URL_140}&sessid={!$Api.Session_ID}&entityType=Email&displaynavi=false&entityid=&entityAction=Create">
                      {!$Label.new}
                    </apex:outputLink>
                    <img style="vertical-align: middle;" height="18px" src="{!URLFOR( $Resource.ExactTargetImages, 'reqEmail.png' )}" />
                    <apex:outputPanel id="exactTargetEmailsA" layout="block">
                      <apex:actionStatus id="clickEmailStatusA">
                        <apex:facet name="start">
                          <img class="spinnerLarge" src="{!URLFOR( $Resource.ExactTargetImages, 'spinEMAIL.GIF' )}" />
                        </apex:facet>
                        <apex:facet name="stop">
                          <apex:outputPanel styleClass="popup" layout="block" rendered="{!ShowEmailChooserA }">
                            <script type="text/javascript">
                              function toggleFolderDisplayA(folderId)
                              {
                              // Identify folder div.
                              var folderDiv = document.getElementById(folderId);

                              // Pull the folder class.
                              var folderClass = folderDiv.className;

                              // Determine if the folder is open or closed.
                              var newFolderClass = 'emailFolder closed';
                              if (folderClass.indexOf('closed') > -1)
                              {
                              newFolderClass = 'emailFolder open';
                              }

                              // Assing new class.
                              folderDiv.className = newFolderClass;
                              }
                            </script>
                            <apex:pageBlock >
                              <apex:pageBlockButtons location="both">
                                <apex:commandButton action="{!selectEmailCancelA}" value="{!$Label.cancel}" rerender="exactTargetEmailsA" status="clickEmailStatusA" />
                              </apex:pageBlockButtons>
                              <apex:repeat value="{!localSendA.emails}" var="emailFolder1">
                                +
                                <a href="#" onclick="javascript:getFolderInfoA('{!emailFolder1.Id}', 'localsendA'); javascript:toggleFolderDisplayA( 'emailFolder_{!emailFolder1.Id}' )">
                                  <b> {!emailFolder1.name} </b>
                                </a>
                                <br />
                                <div class="emailFolder closed" id="emailFolder_{!emailFolder1.Id}">
                                  <apex:repeat value="{!emailFolder1.subfolders}" var="emailFolder2" rendered="{!NOT( ISBLANK( emailFolder1.subfolders ) )}">
                                    +
                                    <a href="#" onclick="javascript:getFolderInfoA('{!emailFolder2.Id}', 'localsendA'); javascript:toggleFolderDisplayA( 'emailFolder_{!emailFolder2.Id}' )">
                                      <b> {!emailFolder2.name} </b>
                                    </a>
                                    <br />
                                    <div class="emailFolder closed" id="emailFolder_{!emailFolder2.Id}">
                                      <apex:repeat value="{!emailFolder2.subfolders}" var="emailFolder3" rendered="{!NOT( ISBLANK( emailFolder2.subfolders ) )}">
                                        +
                                        <a href="#" onclick="javascript:getFolderInfoA('{!emailFolder3.Id}', 'localsendA'); javascript:toggleFolderDisplayA( 'emailFolder_{!emailFolder3.Id}' )">
                                          <b> {!emailFolder3.name} </b>
                                        </a>
                                        <br />
                                        <div class="emailFolder closed" id="emailFolder_{!emailFolder3.Id}">
                                          <apex:repeat value="{!emailFolder3.subfolders}" var="emailFolder4" rendered="{!NOT( ISBLANK( emailFolder3.subfolders ) )}">
                                            +
                                            <a href="#" onclick="javascript:getFolderInfoA('{!emailFolder4.Id}', 'localsendA'); javascript:toggleFolderDisplayA( 'emailFolder_{!emailFolder4.Id}' )">
                                              <b> {!emailFolder4.name} </b>
                                            </a>
                                            <br />
                                            <div class="emailFolder closed" id="emailFolder_{!emailFolder4.Id}">
                                              <apex:repeat value="{!emailFolder4.subfolders}" var="emailFolder5" rendered="{!NOT( ISBLANK( emailFolder4.subfolders ) )}">
                                                +
                                                <a href="#" onclick="javascript:getFolderInfoA('{!emailFolder5.Id}', 'localsendA'); javascript:toggleFolderDisplayA( 'emailFolder_{!emailFolder5.Id}' )">
                                                  <b> {!emailFolder5.name} </b>
                                                </a>
                                                <br />
                                                <div class="emailFolder closed" id="emailFolder_{!emailFolder5.Id}">
                                                  <apex:repeat value="{!emailFolder5.emails}" var="email5">
                                                    &nbsp;-&nbsp;
                                                    <a href="#" onclick="javascript:selectEmailJSA( '{!email5.id}', uriDecodeSubject('{!email5.encName}'), '{!email5.encTitle}', 'A'); setEmailATitle('{!email5.encTitle}'); /*subscriberPreview.setEmailId('{!email5.id}');*/" status="sendButtonStatus">
                                                      {!email5.name}
                                                    </a>
                                                    <br />
                                                  </apex:repeat>
                                                </div>
                                              </apex:repeat>
                                              <apex:repeat value="{!emailFolder4.emails}" var="email4">
                                                &nbsp;-&nbsp;
                                                <a href="#" onclick="javascript:selectEmailJSA( '{!email4.id}', uriDecodeSubject('{!email4.encName}'), '{!email4.encTitle}', 'A'); setEmailATitle('{!email4.encTitle}'); (/*subscriberPreview.setEmailId('{!email4.id}');*/" status="sendButtonStatus"> {!email4.name} </a>
                                                <br />
                                              </apex:repeat>
                                            </div>
                                          </apex:repeat>
                                          <apex:repeat value="{!emailFolder3.emails}" var="email3">
                                            &nbsp;-&nbsp;
                                            <a href="#" onclick="javascript:selectEmailJSA( '{!email3.id}', uriDecodeSubject('{!email3.encName}'), '{!email3.encTitle}', 'A' ); setEmailATitle('{!email3.encTitle}'); /*subscriberPreview.setEmailId('{!email3.id}');*/" status="sendButtonStatus"> {!email3.name} </a>
                                            <br />
                                          </apex:repeat>
                                        </div>
                                      </apex:repeat>
                                      <apex:repeat value="{!emailFolder2.emails}" var="email2">
                                        &nbsp;-&nbsp;
                                        <a href="#" onclick="javascript:selectEmailJSA( '{!email2.id}', uriDecodeSubject('{!email2.encName}'), '{!email2.encTitle}', 'A' ); setEmailATitle('{!email2.encTitle}'); /*subscriberPreview.setEmailId('{!email2.id}');*/" status="sendButtonStatus"> {!email2.name} </a>
                                        <br />
                                      </apex:repeat>
                                    </div>
                                  </apex:repeat>
                                  <apex:repeat value="{!emailFolder1.emails}" var="email1">
                                    &nbsp;-&nbsp;
                                    <a href="#" onclick="javascript:selectEmailJSA( '{!email1.id}', uriDecodeSubject('{!email1.encName}'), '{!email1.encTitle}', 'A' ); setEmailATitle('{!email1.encTitle}'); /*subscriberPreview.setEmailId('{!email1.id}');*/" status="sendButtonStatus"> {!email1.name} </a>
                                    <br />
                                  </apex:repeat>
                                </div>
                              </apex:repeat>
                            </apex:pageBlock>
                          </apex:outputPanel>
                        </apex:facet>
                      </apex:actionStatus>
                    </apex:outputPanel>
                  </apex:outputPanel>
                </apex:outputPanel>
              </apex:pageBlockSectionItem>

              <!-- Email B -->
              <apex:pageBlockSectionItem id="emailBTemplate" helpText="{!$Label.abEmailHelp}">
                <apex:outputLabel for="emailBName" value="{!$Label.email_B}" />
                <apex:outputPanel id="emailBWrapper" layout="block">
                  <apex:outputText id="emailBName" value="{!localSendB.email.name}" />
                  <apex:outputPanel id="emailBPreviewLinkWrapper">
                    <!-- emailPreviewLink panel used to house rerendering of Edit Email. Email preview to come in the future -->
                    <apex:outputPanel id="emailBPreviewLink" rendered="{!IF( NOT( ISNULL( localSendB.email.id ) ), true, false )}">
                      <apex:actionStatus id="previewEmailAStatus">
                        <apex:facet name="start">
                          <img class="spinnerLarge" src="{!URLFOR( $Resource.ExactTargetImages, 'spinEMAIL.GIF' )}" />
                        </apex:facet>
                        <apex:facet name="stop">
                          <apex:outputpanel >
                            <apex:outputLink target="_blank" style="padding-right:10px;padding-left:10px;" value="{!etLink}sessurl={!$Api.Partner_Server_URL_140}&sessid={!$Api.Session_ID}&entityType=Email&displaynavi=false&entityid={!localSendB.email.id}">
                              {!$Label.editEml}
                            </apex:outputLink>
                          </apex:outputpanel>
                        </apex:facet>
                      </apex:actionStatus>
                    </apex:outputPanel>
                  </apex:outputPanel>
                  <apex:outputPanel >
                    <apex:actionStatus id="listEmailsStatusB">
                      <apex:facet name="start">
                        <img class="spinnerLarge" src="{!URLFOR( $Resource.ExactTargetImages, 'spinEMAIL.GIF' )}" />
                      </apex:facet>
                      <apex:facet name="stop">
                        <apex:commandButton id="listEmailsB" value="{!$Label.find}" action="{!listExactTargetEmailsB}" rerender="exactTargetEmailsB,pageMessages,sendEmailForm,recipientReports,recipientReportsZ,exclusionReports,exclusionReportsZ"
                        status="listEmailsStatusB" />
                      </apex:facet>
                    </apex:actionStatus>
                    <apex:outputText value="{!pipe}"/>
                    <apex:outputLink target="_blank" style="padding-right:10px;" value="{!etLink}sessurl={!$Api.Partner_Server_URL_140}&sessid={!$Api.Session_ID}&entityType=Email&displaynavi=false&entityid=&entityAction=Create">
                      {!$Label.new}
                    </apex:outputLink>
                    <img style="vertical-align: middle;" height="18px" src="{!URLFOR( $Resource.ExactTargetImages, 'reqEmail.png' )}" />
                    <apex:outputPanel id="exactTargetEmailsB" layout="block">
                      <apex:actionStatus id="clickEmailStatusB">
                        <apex:facet name="start">
                          <img class="spinnerLarge" src="{!URLFOR( $Resource.ExactTargetImages, 'spinEMAIL.GIF' )}" />
                        </apex:facet>
                        <apex:facet name="stop">
                          <apex:outputPanel styleClass="popup" layout="block" rendered="{!ShowEmailChooserB }">
                            <script type="text/javascript">
                              function toggleFolderDisplayB(folderId)
                              {
                              // Identify folder div.
                              var folderDiv = document.getElementById(folderId);

                              // Pull the folder class.
                              var folderClass = folderDiv.className;

                              // Determine if the folder is open or closed.
                              var newFolderClass = 'emailFolder closed';
                              if (folderClass.indexOf('closed') > -1)
                              {
                              newFolderClass = 'emailFolder open';
                              }

                              // Assing new class.
                              folderDiv.className = newFolderClass;
                              }
                            </script>
                            <apex:pageBlock >
                              <apex:pageBlockButtons location="both">
                                <apex:commandButton action="{!selectEmailCancelB}" value="{!$Label.cancel}" rerender="exactTargetEmailsB" status="clickEmailStatusB" />
                              </apex:pageBlockButtons>
                              <apex:repeat value="{!localSendB.emails}" var="emailFolder1">
                                +
                                <a href="#" onclick="javascript:getFolderInfoB('{!emailFolder1.Id}', 'localsendB'); javascript:toggleFolderDisplayB( 'emailFolder_{!emailFolder1.Id}' )">
                                  <b> {!emailFolder1.name} </b>
                                </a>
                                <br />
                                <div class="emailFolder closed" id="emailFolder_{!emailFolder1.Id}">
                                  <apex:repeat value="{!emailFolder1.subfolders}" var="emailFolder2" rendered="{!NOT( ISBLANK( emailFolder1.subfolders ) )}">
                                    +
                                    <a href="#" onclick="javascript:getFolderInfoB('{!emailFolder2.Id}', 'localsendB'); javascript:toggleFolderDisplayB( 'emailFolder_{!emailFolder2.Id}' )">
                                      <b> {!emailFolder2.name} </b>
                                    </a>
                                    <br />
                                    <div class="emailFolder closed" id="emailFolder_{!emailFolder2.Id}">
                                      <apex:repeat value="{!emailFolder2.subfolders}" var="emailFolder3" rendered="{!NOT( ISBLANK( emailFolder2.subfolders ) )}">
                                        +
                                        <a href="#" onclick="javascript:getFolderInfoB('{!emailFolder3.Id}', 'localsendB'); javascript:toggleFolderDisplayB( 'emailFolder_{!emailFolder3.Id}' )">
                                          <b> {!emailFolder3.name} </b>
                                        </a>
                                        <br />
                                        <div class="emailFolder closed" id="emailFolder_{!emailFolder3.Id}">
                                          <apex:repeat value="{!emailFolder3.subfolders}" var="emailFolder4" rendered="{!NOT( ISBLANK( emailFolder3.subfolders ) )}">
                                            +
                                            <a href="#" onclick="javascript:getFolderInfoB('{!emailFolder4.Id}', 'localsendB'); javascript:toggleFolderDisplayB( 'emailFolder_{!emailFolder4.Id}' )">
                                              <b> {!emailFolder4.name} </b>
                                            </a>
                                            <br />
                                            <div class="emailFolder closed" id="emailFolder_{!emailFolder4.Id}">
                                              <apex:repeat value="{!emailFolder4.subfolders}" var="emailFolder5" rendered="{!NOT( ISBLANK( emailFolder4.subfolders ) )}">
                                                +
                                                <a href="#" onclick="javascript:getFolderInfoB('{!emailFolder5.Id}', 'localsendB'); javascript:toggleFolderDisplayB( 'emailFolder_{!emailFolder5.Id}' )">
                                                  <b> {!emailFolder5.name} </b>
                                                </a>
                                                <br />
                                                <div class="emailFolder closed" id="emailFolder_{!emailFolder5.Id}">
                                                  <apex:repeat value="{!emailFolder5.emails}" var="email5">
                                                    &nbsp;-&nbsp;
                                                    <a href="#" onclick="javascript:selectEmailJSB( '{!email5.id}', uriDecodeSubject('{!email5.encName}'), '{!email5.encTitle}', 'B' ); setEmailBTitle('{!email5.encTitle}'); /*subscriberPreview.setEmailId('{!email5.id}');*/" status="sendButtonStatus">
                                                      {!email5.name}
                                                    </a>
                                                    <br />
                                                  </apex:repeat>
                                                </div>
                                              </apex:repeat>
                                              <apex:repeat value="{!emailFolder4.emails}" var="email4">
                                                &nbsp;-&nbsp;
                                                <a href="#" onclick="javascript:selectEmailJSB( '{!email4.id}', uriDecodeSubject('{!email4.encName}'), '{!email4.encTitle}', 'B' ); setEmailBTitle('{!email4.encTitle}'); /*subscriberPreview.setEmailId('{!email4.id}');*/" status="sendButtonStatus"> {!email4.name} </a>
                                                <br />
                                              </apex:repeat>
                                            </div>
                                          </apex:repeat>
                                          <apex:repeat value="{!emailFolder3.emails}" var="email3">
                                            &nbsp;-&nbsp;
                                            <a href="#" onclick="javascript:selectEmailJSB( '{!email3.id}', uriDecodeSubject('{!email3.encName}'), '{!email3.encTitle}', 'B' ); setEmailBTitle('{!email3.encTitle}'); /*subscriberPreview.setEmailId('{!email3.id}');*/" status="sendButtonStatus"> {!email3.name} </a>
                                            <br />
                                          </apex:repeat>
                                        </div>
                                      </apex:repeat>
                                      <apex:repeat value="{!emailFolder2.emails}" var="email2">
                                        &nbsp;-&nbsp;
                                        <a href="#" onclick="javascript:selectEmailJSB( '{!email2.id}', uriDecodeSubject('{!email2.encName}'), '{!email2.encTitle}', 'B' ); setEmailBTitle('{!email2.encTitle}'); /*subscriberPreview.setEmailId('{!email2.id}');*/" status="sendButtonStatus"> {!email2.name} </a>
                                        <br />
                                      </apex:repeat>
                                    </div>
                                  </apex:repeat>
                                  <apex:repeat value="{!emailFolder1.emails}" var="email1">
                                    &nbsp;-&nbsp;
                                    <a href="#" onclick="javascript:selectEmailJSB( '{!email1.id}', uriDecodeSubject('{!email1.encName}'), '{!email1.encTitle}', 'B' ); setEmailBTitle('{!email1.encTitle}'); /*subscriberPreview.setEmailId('{!email1.id}');*/" status="sendButtonStatus"> {!email1.name} </a>
                                    <br />
                                  </apex:repeat>
                                </div>
                              </apex:repeat>
                            </apex:pageBlock>
                          </apex:outputPanel>
                        </apex:facet>
                      </apex:actionStatus>
                    </apex:outputPanel>
                  </apex:outputPanel>
                </apex:outputPanel>
              </apex:pageBlockSectionItem>
            </apex:pageBlockSection>
            <!-- AB Subject Panel -->
            <apex:outputPanel id="absubjectbuttons" styleClass="subjectselectborder radioselect absubjectoptions">
              <apex:selectRadio enabledClass="radioselectoptions" value="{!selectedSubjectOption}">
                <apex:selectOptions value="{!SubjectOptions}" />
              </apex:selectRadio>
            </apex:outputPanel>
            <apex:pageBlockSection id="abEmailSingleSubjectPanel">
              <apex:pageBlockSectionItem id="abEmailSingleSubject" helpText="{!$Label.msg0051}">
                <apex:outputLabel value="{!$Label.subject}" />
                <apex:outputPanel >
                  <apex:inputText style="margin-right:10px; width=200px;" value="{!localSendA.email.title}" />
                  <span>
                    <img style="vertical-align: middle;" height="18px"
										src="{!URLFOR( $Resource.ExactTargetImages, 'reqEmail.png' )}" />
                  </span>
                </apex:outputPanel>
              </apex:pageBlockSectionItem>
            </apex:pageBlockSection>
            <apex:pageBlockSection id="abSubjectPanel">
              <apex:pageBlockSectionItem id="emailsubjecta" helpText="{!$Label.msg0051}">
                <apex:outputLabel value="{!$Label.AB_Test_Subject_A}" />
                <apex:outputPanel >
                  <apex:inputText style="margin-right:10px; margin-bottom: 5px; width=200px;" value="{!localSendA.email.title}" />
                  <span>
                    <img style="vertical-align: middle;" height="18px"
                    src="{!URLFOR( $Resource.ExactTargetImages, 'reqEmail.png' )}" />
                  </span>
                  <div>
                    <input id="aOrBPicker-A" class="aOrBPicker" type="radio" name="useSubjectAorB" value="A">{!$Label.useSubjectA}</input>
                  </div>
                </apex:outputPanel>
              </apex:pageBlockSectionItem>
              <apex:pageBlockSectionItem id="emailsubjectb" dataStyleClass="subjectB" labelStyleClass="subjectB" helpText="{!$Label.msg0051}">
                <apex:outputLabel style="margin-right:10px" value="{!$Label.AB_Test_Subject_B}" />
                <apex:outputPanel >
                  <apex:inputText style="margin-right:10px; margin-bottom: 5px; width=200px;" value="{!localSendB.email.title}" />
                  <span>
                    <img style="vertical-align: middle;" height="18px"
										src="{!URLFOR( $Resource.ExactTargetImages, 'reqEmail.png' )}" />
                  </span>
                  <div>
                    <input id="aOrBPicker-B" class="aOrBPicker" type="radio" name="useSubjectAorB" value="B">{!$Label.useSubjectB}</input>
                  </div>
                </apex:outputPanel>
              </apex:pageBlockSectionItem>
            </apex:pageBlockSection>
            <!-- Subject -->
            <apex:pageBlockSectionItem id="emailsubject" helpText="{!$Label.abSubjectHelp}">
              <apex:outputLabel value="{!$Label.subject}" />
              <apex:outputPanel >
                <apex:inputText id="emailSubectSingleText" style="margin-right:20px; width=200px;" value="{!localSend.email.title}" />
                <img style="vertical-align: middle;" height="18px" src="{!URLFOR( $Resource.ExactTargetImages, 'reqEmail.png' )}" />
              </apex:outputPanel>
            </apex:pageBlockSectionItem>
            <!-- AB Content Area Info Panel -->
            <apex:pageBlockSection id="abContentAreaInfo">
              <apex:pageBlockSectionItem helpText="{!$Label.abContentAreaHelp}">
                <apex:outputLabel value="{!$Label.abContentAreaA}" />
                <apex:outputPanel >
                  <table>
                    <tbody>
                      <tr>
                        <td>{!contentAreaA.name}</td>
                      </tr>
                      <tr>
                        <td>{!$Label.created}: {!contentAreaA.createdDate}</td>
                      </tr>
                      <tr>
                        <td>Last Modified: {!contentAreaA.modifiedDate}</td>
                      </tr>
                    </tbody>
                  </table>
                </apex:outputPanel>
              </apex:pageBlockSectionItem>
              <apex:pageBlockSectionItem helpText="{!$Label.abContentAreaHelp}">
                <apex:outputLabel value="{!$Label.abContentAreaB}" />
                <apex:outputPanel >
                  <table>
                    <tbody>
                      <tr>
                        <td>{!contentAreaB.name}</td>
                      </tr>
                      <tr>
                        <td>Created: {!contentAreaB.createdDate}</td>
                      </tr>
                      <tr>
                        <td>Last Modified: {!contentAreaB.modifiedDate}</td>
                      </tr>
                    </tbody>
                  </table>
                </apex:outputPanel>
              </apex:pageBlockSectionItem>
            </apex:pageBlockSection>
            <!-- From A -->
            <apex:pageBlockSection id="abFromNamePanel">
              <apex:pageBlockSectionitem id="selectedFromA" helptext="{!$Label.abFromNameHelp}">
                <apex:outputLabel for="fromBlockA" value="{!$Label.AB_Test_From_Name_A}" />
                <apex:outputPanel id="fromBlockA" layout="block">
                  <apex:outputPanel layout="block">
                    <input type="radio" id="fromSelectorEmailA" name="fromSelectorA" value="{!fromSelectorAStatus}" onclick="swapFromSource('testA');" status="sendButtonStatus" />
                    <apex:outputLabel for="fromA" value="{!$Label.emailAddr}" />
                    <br />
                    <apex:outputPanel id="fromPicklistA">
                      <table>
                        <tr>
                          <td>
                            <apex:selectList id="fromA" value="{!localSendA.fromEmailSelected}" size="1">
                              <apex:selectOptions value="{!abFromOptions}" />
                            </apex:selectList>
                          </td>
                          <td>
                            <img style="vertical-align: middle;" height="18px" src="{!URLFOR( $Resource.ExactTargetImages, 'reqEmail.png' )}" />
                          </td>
                        </tr>
                      </table>
                    </apex:outputPanel>
                  </apex:outputPanel>
                  <apex:outputPanel id="sendClassificationWrapperA" layout="block" rendered="true">
                    <input type="radio" id="fromSelectorSCA" name="fromSelectorA" value="{!localSendA.SendClassOption}" onclick="swapFromSource('testA');" status="sendButtonStatus"
                                        />
                    <apex:outputLabel for="sendClassificationA" value="{!$Label.sendClass}" />
                    <br />
                    <apex:outputPanel id="scPicklistA">
                      <apex:selectList id="sendClassificationA" value="{!localSendA.sendClassificationSelected}" size="1">
                        <apex:selectOptions value="{!localSend.sendClassificationOptions}" />
                      </apex:selectList>
                      <img style="vertical-align: middle;" height="18px" src="{!URLFOR( $Resource.ExactTargetImages, 'reqEmail.png' )}" />
                    </apex:outputPanel>
                  </apex:outputPanel>
                </apex:outputPanel>
              </apex:pageBlockSectionitem>

              <!-- From B -->
              <apex:pageBlockSectionitem id="selectedFromB" helptext="{!$Label.abFromNameHelp}">
                <apex:outputLabel for="fromBlockB" value="{!$Label.AB_Test_From_Name_B}" />
                <apex:outputPanel id="fromBlockB" layout="block">
                  <apex:outputPanel layout="block">
                    <input type="radio" id="fromSelectorEmailB" name="fromSelectorB" value="{!fromSelectorBStatus}" onclick="swapFromSource('testB');" status="sendButtonStatus" />
                    <apex:outputLabel for="fromB" value="{!$Label.emailAddr}" />
                    <br />
                    <apex:outputPanel id="fromPicklistB">
                      <table>
                        <tr>
                          <td>
                            <apex:selectList id="fromB" value="{!localSendB.fromEmailSelected}" size="1">
                              <apex:selectOptions value="{!abFromOptions}" />
                            </apex:selectList>
                          </td>
                          <td>
                            <img style="vertical-align: middle;" height="18px" src="{!URLFOR( $Resource.ExactTargetImages, 'reqEmail.png' )}" />
                          </td>
                        </tr>
                      </table>
                    </apex:outputPanel>
                  </apex:outputPanel>
                  <apex:outputPanel id="sendClassificationWrapperB" layout="block" rendered="true">
                    <input type="radio" id="fromSelectorSCB" name="fromSelectorB" value="{!localSendB.SendClassOption}" onclick="swapFromSource('testB');" status="sendButtonStatus" />
                    <apex:outputLabel for="sendClassificationB" value="{!$Label.sendClass}" />
                    <br />
                    <apex:outputPanel id="scPicklistB">
                      <apex:selectList id="sendClassificationB" value="{!localSendB.sendClassificationSelected}" size="1">
                        <apex:selectOptions value="{!localSend.sendClassificationOptions}" />
                      </apex:selectList>
                      <img style="vertical-align: middle;" height="18px" src="{!URLFOR( $Resource.ExactTargetImages, 'reqEmail.png' )}" />
                    </apex:outputPanel>
                  </apex:outputPanel>
                </apex:outputPanel>
              </apex:pageBlockSectionitem>
            </apex:pageBlockSection>

            <!-- AB Send Date/Time -->
            <apex:pageBlockSection id="abSendDateTimePanel">
              <apex:pageBlockSectionItem id="sendDateTimeRadiosA" helpText="{!$Label.abDateTimeHelp}">
                <apex:outputLabel for="dateBlockA" value="{!$Label.AB_Test_Send_Date_A}" />
                <apex:outputPanel id="dateBlockA" layout="block">
                  <apex:outputPanel id="sendDateTimeWrapperA" layout="block" rendered="true">
                    <apex:outputPanel id="schCalendarA">
                      <apex:inputField id="sendDateTimeA" value="{!sendA.et4ae5__Scheduled_Date_Time__c}" />
                      <img style="vertical-align: middle;" height="18px" src="{!URLFOR( $Resource.ExactTargetImages, 'reqEmail.png' )}" />
                    </apex:outputPanel>
                  </apex:outputPanel>
                </apex:outputPanel>
                </apex:pageBlockSectionitem>
                <apex:pageBlockSectionItem id="sendDateTimeRadiosB" helpText="{!$Label.abDateTimeHelp}">
                  <apex:outputLabel for="dateBlockB" value="{!$Label.AB_Test_Send_Date_B}" />
                  <apex:outputPanel id="dateBlockB" layout="block">
                    <apex:outputPanel id="sendDateTimeWrapperB" layout="block" rendered="true">
                      <apex:outputPanel id="schCalendarB">
                        <apex:inputField id="sendDateTimeB" value="{!sendB.et4ae5__Scheduled_Date_Time__c}" />
                        <img style="vertical-align: middle;" height="18px" src="{!URLFOR( $Resource.ExactTargetImages, 'reqEmail.png' )}" />
                      </apex:outputPanel>
                    </apex:outputPanel>
                  </apex:outputPanel>
                  </apex:pageBlockSectionitem>
                </apex:pageBlockSection>
          </apex:pageBlockSection>
          <!-- End of Test Management Block -->

          <!-- Recipients -->
          <br />
          <hr color="#FFA100" />
          <div style="font-size: 14px; color: #4f4f4f; font-family: 'Helvetica', 'Arial', sans-serif; font-weight: bold;">
            Recipients
          </div>
          <hr color="#ececec" />

          <apex:pageblocksection id="listChoosers" columns="1">
            <!-- Recipient Sources -->
            <apex:pageBlockSectionItem helpText="{!$Label.abAudienceHelp}">
              <apex:outputLabel value="{!$Label.recipients}" />
              <apex:outputPanel layout="block">
                <apex:outputPanel id="recipSourcePicklists">
                  <table>
                    <tr>
                      <td>
                        <apex:actionStatus id="recipPicklistStatus">
                          <apex:facet name="start">
                            <apex:outputPanel >
                              <img class="spinnerLarge" src="{!URLFOR( $Resource.ExactTargetImages, 'spinEMAIL.GIF' )}" />
                            </apex:outputPanel>
                          </apex:facet>
                          <apex:facet name="stop">
                            <apex:outputPanel >
                              <apex:selectList id="recipSourceDropdown" value="{!recipientType}" size="1">
                                <apex:selectOptions value="{!recipSource}" />
                                <apex:actionSupport event="onchange" action="{!changeRecipientType}" rerender="listChoosers" status="recipPicklistStatus" />
                              </apex:selectList>
                              <apex:image value="/s.gif" style="width: 5px;" />
                              <apex:outputPanel id="campaignInput" rendered="{!renderRecipCampaign}">
                                <apex:inputField id="campaignRecip" value="{!send.et4ae5__Campaign__c}" style="width: 300px;" />
                              </apex:outputPanel>
                            </apex:outputPanel>
                          </apex:facet>
                        </apex:actionStatus>
                      </td>
                      <td>
                        <apex:outputLink value="javascript:inclusionAdd();">
                          <apex:image value="{!URLFOR( $Resource.et4ae5__ExactTargetImages, 'plusOn.jpg' )}" alt="{!$Label.add}" title="{!$Label.add}" />
                        </apex:outputLink>
                      </td>
                    </tr>
                  </table>
                  <apex:outputPanel id="recipientReportsZ">
                    <apex:actionStatus id="clickReportStatus">
                      <apex:facet name="start">
                        <img class="spinnerLarge" src="{!URLFOR( $Resource.ExactTargetImages, 'spinEMAIL.GIF' )}" />
                      </apex:facet>
                      <apex:facet name="stop">
                        <apex:outputPanel styleClass="popup" rendered="{!showRecipientReportChooser}">
                          <apex:pageBlock >
                            <apex:pageBlockButtons location="both">
                              <apex:commandButton action="{!selectSalesforceReportCancel}" value="{!$Label.cancel}" rerender="sendEmailForm,recipientReports,recipientReportsZ,exactTargetEmails,exclusionReports,exclusionReportsZ"
                              status="listRecipientReportsStatus" />
                            </apex:pageBlockButtons>
                            <input type="text" placeholder="{!$Label.findFolder}" id="folderSearch" onkeyup="doReportFolderSearch();"/>
                            <br/>
                            <apex:outputpanel id="foldersReturned">
                              <apex:outputLabel value="{!limitMessage}" style="color:red;font-weight:bold;display:block;"/>
                              <apex:repeat value="{!localSend.reports}" var="recipientReportsFolder">
                                +
                                <a href="#" onclick="openReportFolder('{!recipientReportsFolder.Id}')">
                                  <b> {!recipientReportsFolder.name} </b>
                                </a>
                                <br />
                                <div id="reportFolder_{recipientReportsFolder.Id}">
                                  <apex:repeat value="{!recipientReportsFolder.contents}" var="recipientReport" rendered="{!NOT(ISBLANK(recipientReportsFolder.contents))}">
                                    &nbsp;-&nbsp;
                                    <a href="#" onclick="javascript:selectReportJS( '{!recipientReport.id}', '{!recipientReport.encName}' );">
                                      {!recipientReport.name}
                                    </a>
                                    <br />
                                  </apex:repeat>
                                </div>
                              </apex:repeat>
                            </apex:outputpanel>
                          </apex:pageBlock>
                        </apex:outputPanel>
                      </apex:facet>
                    </apex:actionStatus>
                  </apex:outputPanel>
                  <table>
                    <tr>
                      <td valign="top">
                        <select id="recipRightList" class="multilist" size="3" style="width: 300px;">
                          <apex:repeat value="{!recipChosen}" var="recipChosens">
                            <option value="{!recipChosens.value}">
                              {!recipChosens.label}
                            </option>
                          </apex:repeat>
                        </select>
                      </td>
                      <td>
                        <table>
                          <tr>
                            <td>
                              <img style="vertical-align: middle;" height="18px" src="{!URLFOR( $Resource.ExactTargetImages, 'reqEmail.png' )}" />
                            </td>
                          </tr>
                          <tr>
                            <td>
                              <apex:outputLink value="javascript:inclusionRemove(document.getElementById('recipRightList').options[document.getElementById('recipRightList').selectedIndex].value);">
                                <apex:image value="{!URLFOR( $Resource.et4ae5__ExactTargetImages, recipMinus )}" />
                              </apex:outputLink>
                            </td>
                          </tr>
                        </table>
                      </td>
                    </tr>
                  </table>
                </apex:outputPanel>
              </apex:outputPanel>
            </apex:pageBlockSectionItem>
            <!-- Exclusion Sources -->
            <apex:pageBlockSectionItem helpText="{!$Label.abExclusionsHelp}" rendered="{!showExclusionSection}" id="exclusionSection">
              <apex:outputLabel value="{!$Label.exclusions}" />
              <apex:outputPanel layout="block">
                <apex:outputPanel id="excluSourcePicklists">
                  <table>
                    <tr>
                      <td>
                        <apex:selectList id="excluSourceDropdown" value="{!exclusionType}" size="1">
                          <apex:selectOptions value="{!excluSource}" />
                          <apex:actionSupport event="onchange" action="{!changeExclusionType}" rerender="listChoosers" />
                        </apex:selectList>
                        <apex:image value="/s.gif" style="width: 5px;" />
                        <apex:outputPanel id="campaignExcluInput" rendered="{!renderExcluCampaign}">
                          <apex:inputField id="campaignExclu" value="{!send.et4ae5__ExclusionCampaign__c}" style="width: 300px;" />
                        </apex:outputPanel>
                      </td>
                      <td>
                        <apex:outputLink value="javascript:exclusionAdd();">
                          <apex:image value="{!URLFOR( $Resource.et4ae5__ExactTargetImages, 'plusOn.jpg' )}" alt="{!$Label.add}" title="{!$Label.add}" />
                        </apex:outputLink>
                      </td>
                    </tr>
                  </table>
                  <apex:outputPanel id="exclusionReportsZ">
                    <apex:actionStatus id="clickExcluReportStatus">
                      <apex:facet name="start">
                        <img class="spinnerLarge" src="{!URLFOR( $Resource.ExactTargetImages, 'spinEMAIL.GIF' )}" />
                      </apex:facet>
                      <apex:facet name="stop">
                        <apex:outputPanel styleClass="popup" rendered="{!showExclusionReportChooser}">
                          <apex:pageBlock >
                            <apex:pageBlockButtons location="both">
                              <apex:commandButton action="{!selectSalesforceExcluReportCancel}" value="{!$Label.cancel}" rerender="sendEmailForm,exclusionReports,exclusionReportsZ,exactTargetEmails,recipientReports,recipientReportsZ"
                              status="listExclusionReportsStatus" />
                            </apex:pageBlockButtons>
                            <input type="text" placeholder="{!$Label.findFolder}" id="folderSearchExc" onkeyup="doReportfolderSearchExc();"/>
                            <br/>
                            <apex:outputpanel id="foldersReturnedExc">
                              <apex:outputLabel value="{!limitMessage}" style="color:red;font-weight:bold;display:block;"/>
                              <apex:repeat value="{!localSend.exclusionReports}" var="exclusionReportsFolder">
                                +
                                <a href="#" onclick="openExcluReportFolder('{!exclusionReportsFolder.Id}')">
                                  <b> {!exclusionReportsFolder.name} </b>
                                </a>
                                <br />
                                <div id="excluReportFolder_{exclusionReportsFolder.Id}">
                                  <apex:repeat value="{!exclusionReportsFolder.contents}" var="exclusionReport" rendered="{!NOT(ISBLANK(exclusionReportsFolder.contents))}">
                                    &nbsp;-&nbsp;
                                    <a href="#" onclick="javascript:selectExcluReportJS( '{!exclusionReport.id}', '{!exclusionReport.encName}' );">
                                      {!exclusionReport.name}
                                    </a>
                                    <br />
                                  </apex:repeat>
                                </div>
                              </apex:repeat>
                            </apex:outputpanel>
                          </apex:pageBlock>
                        </apex:outputPanel>
                      </apex:facet>
                    </apex:actionStatus>
                  </apex:outputPanel>
                  <table>
                    <tr>
                      <td valign="top">
                        <select id="excluRightList" class="multilist" size="3" style="width: 300px;">
                          <apex:repeat value="{!excluChosen}" var="excluChosens">
                            <option value="{!excluChosens.value}">
                              {!excluChosens.label}
                            </option>
                          </apex:repeat>
                        </select>
                      </td>
                      <td>
                        <table>
                          <tr>
                            <td height="18px" />
                          </tr>
                          <tr>
                            <td>
                              <apex:outputLink value="javascript:exclusionRemove(document.getElementById('excluRightList').options[document.getElementById('excluRightList').selectedIndex].value);">
                                <apex:image value="{!URLFOR( $Resource.et4ae5__ExactTargetImages, excluMinus )}" />
                              </apex:outputLink>
                            </td>
                          </tr>
                        </table>
                      </td>
                    </tr>
                  </table>
                </apex:outputPanel>
              </apex:outputPanel>
            </apex:pageBlockSectionItem>
          </apex:pageblocksection>
          <hr color="#ececec" />
          <!-- Slider -->
          <apex:pageBlockSection >
            <apex:pageBlockSectionItem helpText="{!$Label.abAudienceSizeHelp}" >
              <apex:outputLabel value="{!$Label.abSliderPct}" />
              <apex:outputPanel >
                <div id="slider"></div>
                <div style="text-align: center">
                  <output>{!$Label.tstGroup}</output>
                  <output id="testGroup" name="testPercent">50</output>
                  <output>%</output>
                </div>
              </apex:outputPanel>
            </apex:pageBlockSectionItem>
            <apex:pageBlockSectionItem >
              <apex:outputLabel />
              <apex:outputPanel >
                <table>
                  <tr>
                    <td>{!$Label.tstA}</td>
                    <td>
                      <output id="groupA">25</output>%
                    </td>
                  </tr>
                  <tr>
                    <td>{!$Label.tstB}</td>
                    <td>
                      <output id="groupB">25</output>%
                    </td>
                  </tr>
                  <tr>
                    <td>{!$Label.remainder}</td>
                    <td>
                      <output id="remainder">50</output>%
                    </td>
                  </tr>
                </table>
              </apex:outputPanel>
            </apex:pageBlockSectionItem>
          </apex:pageBlockSection>
          <!-- End of slider -->
          <br />
          <hr color="#FFA100" />
          <div style="font-size: 14px; color: #4f4f4f; font-family: 'Helvetica', 'Arial', sans-serif; font-weight: bold;">
            {!$Label.winner}
          </div>
          <hr color="#ececec" />
          <apex:pageblocksection id="winnerblock" columns="1">
            <apex:pageblocksectionitem helptext="{!$Label.abDetermineWinnerByHelp}">
              <apex:outputLabel value="{!$Label.dtrmnWinner}" />
              <apex:outputPanel >
                <apex:selectRadio value="{!selectedChooseWinnerByOption}" layout="pageDirection">
                  <apex:selectOptions value="{!DetermineWinnerOptions}" />
                </apex:selectRadio>
              </apex:outputPanel>
            </apex:pageblocksectionitem>
            <apex:pageblocksectionitem helptext="{!$Label.abTestDurationHelp}">
              <apex:outputLabel value="{!$Label.abTestDeclareWinner}" />
              <apex:outputPanel >
                <apex:inputText id="winnerTimeNumber" value="{!declareWinnerTime}" style="width:20px; margin-right:10px;" />
                <apex:selectList value="{!selectedWinnerDaysHours}" multiselect="false" size="1">
                  <apex:selectOptions value="{!WinnerDaysHoursOptions}" />
                </apex:selectList>
                <apex:outputLabel value="{!$Label.abTestAfterWinner}" />
                <img style="vertical-align: middle;" height="18px" src="{!URLFOR( $Resource.ExactTargetImages, 'reqEmail.png' )}" />
              </apex:outputPanel>
            </apex:pageblocksectionitem>
            </apex:pageBlockSection>
            <apex:pageBlockSection id="saveWinningTest">
              <apex:pageblocksectionitem helptext="{!$Label.abSaveWinningSubjectHelp}">
                <apex:outputLabel value="{!$Label.saveWinOpt}" />
                <apex:outputPanel >
                  <apex:selectRadio value="{!selectedSaveWinningTest}" layout="pageDirection">
                    <apex:selectOptions value="{!SaveWinningTestOptions}" />
                  </apex:selectRadio>
                </apex:outputPanel>
              </apex:pageblocksectionitem>
            </apex:pageblocksection>
          <br />
          <hr color="#FFA100" />
          <div style="font-size: 14px; color: #4f4f4f; font-family: 'Helvetica', 'Arial', sans-serif; font-weight: bold;">
            {!$Label.sendMgmt}
          </div>
          <hr color="#ececec" />
          <apex:pageblocksection id="bottomBlock" columns="1">
            <apex:pageBlockSectionItem helpText="{!$Label.abSendToRemainderHelp}">
              <apex:outputLabel value="{!$Label.sendWinToRem}" />
              <apex:outputPanel >
                <apex:selectList id="transmissiontype" value="{!transmissionType}" multiselect="false" size="1">
                  <apex:selectOptions value="{!transmissionTypeOptions}" />
                </apex:selectList>
                <apex:selectList id="automatictransmissionselection" value="{!automaticTransmissionType}" multiselect="false" size="1">
                  <apex:selectOptions value="{!automaticTransmissionTypeOptions}" />
                </apex:selectList>
                <apex:inputField id="ScheduledSendRemainderDateTime" value="{!SendRemainderFields.et4ae5__Scheduled_Date_Time__c}" />
              </apex:outputPanel>
            </apex:pageBlockSectionItem>
            <!-- From -->
            <apex:pageBlockSectionitem id="selectedFrom" helptext="{!$Label.abFromNameAndEmailHelp}">
              <apex:outputLabel for="fromBlock" value="{!$Label.from}" />
              <apex:outputPanel id="fromBlock" layout="block">
                <apex:outputPanel layout="block">
                  <input type="radio" id="fromSelectorEmail" name="fromSelector" value="{!!localSend.SendClassOption}" onclick="swapFromSource('');" status="sendButtonStatus" />
                  <apex:outputLabel for="from" value="{!$Label.emailAddr}" />
                  <br />
                  <apex:outputPanel id="fromPicklist">
                    <apex:selectList id="fromSingle" value="{!localSend.fromEmailSelected}" size="1">
                      <apex:selectOptions value="{!abFromOptions}" />
                    </apex:selectList>
                    <img style="vertical-align: middle;" height="18px" src="{!URLFOR( $Resource.ExactTargetImages, 'reqEmail.png' )}" />
                  </apex:outputPanel>
                </apex:outputPanel>
                <apex:outputPanel id="sendClassificationWrapper" layout="block" rendered="true">
                  <input type="radio" id="fromSelectorSC" name="fromSelector" value="{!localSend.SendClassOption}" onclick="swapFromSource('');" status="sendButtonStatus" />
                  <apex:outputLabel for="sendClassification" value="{!$Label.sendClass}" />
                  <br />
                  <apex:outputPanel id="scPicklist">
                    <apex:selectList id="sendClassificationSingle" value="{!localSend.sendClassificationSelected}" size="1">
                      <apex:selectOptions value="{!localSend.sendClassificationOptions}" />
                    </apex:selectList>
                    <img style="vertical-align: middle;" height="18px" src="{!URLFOR( $Resource.ExactTargetImages, 'reqEmail.png' )}" />
                  </apex:outputPanel>
                </apex:outputPanel>
              </apex:outputPanel>
            </apex:pageBlockSectionitem>

            <!-- Reply-to -->
            <apex:pageBlockSectionitem rendered="{!renderReplyTo}" id="selectedReplyTo" helpText="{!$Label.abSendRepliesToHelp}">
              <apex:outputLabel value="{!$Label.reply_to}" />
              <apex:selectList id="reply-to" value="{!localSend.replyToEmailSelected}" size="1">
                <apex:selectOptions value="{!localSend.replyToOptions}" />
              </apex:selectList>
            </apex:pageBlockSectionitem>

            <!-- Scheduled Send Date/Time -->
            <apex:pageBlockSectionItem id="sendDateTimeRadios" helpText="{!$Label.abStartTestHelp}">
              <apex:outputLabel for="dateBlock" value="{!$Label.sndDAndT}" />
              <apex:outputPanel id="dateBlock" layout="block">
                <apex:outputPanel layout="block">
                  <input type="radio" id="fromSelectorIm" name="immeSelector" onclick="swapDateSource(''); setSendImmediately();" status="sendButtonStatus" />
                  <apex:outputLabel for="imme" value="{!$Label.immedtly}" />
                </apex:outputPanel>
                <apex:outputPanel id="sendDateTimeWrapper" layout="block" rendered="true">
                  <input type="radio" id="fromSelectorDT" name="immeSelector" onclick="swapDateSource(''); setSendFuture();" status="sendButtonStatus" />
                  <apex:outputLabel for="sendDateTime" value="{!$Label.schedFutSd}" />
                  <br />
                  <apex:outputPanel id="schCalendar">
                    <apex:inputField id="sendDateTimeSingle" value="{!send.et4ae5__Scheduled_Date_Time__c}" />
                    <img style="vertical-align: middle;" height="18px" src="{!URLFOR( $Resource.ExactTargetImages, 'reqEmail.png' )}" />
                  </apex:outputPanel>
                </apex:outputPanel>
              </apex:outputPanel>
              </apex:pageBlockSectionitem>

              <!-- Dedupe Subscribers -->
              <apex:pageBlockSectionItem helpText="{!$Label.msg0006}">
                <apex:outputLabel value="{!$Label.dedupeSubs}" />
                <apex:inputCheckbox value="{!send.et4ae5__DedupeSubscribers__c}" selected="true"/>
              </apex:pageBlockSectionItem>

              <!-- Disable Individual Tracking -->
              <apex:pageBlockSectionItem rendered="{!renderDIT}" helpText="{!$Label.abDisableIndLevelTrackingHelp}">
                <apex:outputLabel value="{!$Label.disILT}" />
                <apex:inputCheckbox value="{!send.et4ae5__Individual_Tracking_Disabled__c}" />
              </apex:pageBlockSectionItem>

              <!-- Email Notifications -->
              <apex:pageBlockSectionItem helpText="{!$Label.abEmailNotificationsHelp}">
                <apex:outputLabel value="{!$Label.abTestEmailNotifications}" />
                <apex:outputPanel >
                  <div>
                    <apex:inputText value="{!emailNotifications}" />
                  </div>
                  <div>
                    <apex:outputLabel value="{!$Label.separateWithComma}" />
                  </div>
                  <table>
                    <tr>
                      <td>
                        <apex:inputCheckbox value="{!notifyForConditions}" />
                      </td>
                      <td>
                        <apex:outputLabel value="{!$Label.abNotificationConditions}" />
                      </td>
                    </tr>
                    <tr>
                      <td>
                        <apex:inputCheckbox value="{!notifyForWinnerDeclared}" />
                      </td>
                      <td>
                        <apex:outputLabel value="{!$Label.winnerIsDeclared}" />
                      </td>
                    </tr>
                    <tr>
                      <td>
                        <apex:inputCheckbox value="{!notifyForRemainderSent}" />
                      </td>
                      <td>
                        <apex:outputLabel value="{!$Label.abNotificationRemainder}" />
                      </td>
                    </tr>
                    <tr>
                      <td>
                        <apex:inputCheckbox value="{!notifyForError}" />
                      </td>
                      <td>
                        <apex:outputLabel value="{!$Label.abNotificationError}" />
                      </td>
                    </tr>
                  </table>
                </apex:outputPanel>
              </apex:pageBlockSectionItem>
              </apex:pageBlockSection>

              <apex:pageBlockSection id="optInSection">
                <!-- Certify Opt-in -->
                <apex:pageBlockSectionItem helpText="{!$Label.msg0058}">
                  <apex:outputLabel value="{!$Label.optInCrtfy}" />
                  <apex:inputCheckbox id="optInCheckbox" value="{!abOptIn}" onclick="callSetTestPercentage()">
                    <apex:actionSupport event="onclick" action="{!abSendEnabler}" rerender="sendbutton" />
                  </apex:inputCheckbox>
                </apex:pageBlockSectionItem>
              </apex:pageBlockSection>
              <!-- Send Button -->
              <apex:pageBlockSection id="sendbutton">
                <!-- Send Button -->
                <!-- Two send buttons are used to preserve styling differences between enabled and disabled states. -->
                <apex:pageBlockSectionItem >
                  <apex:outputLabel value="" />
                  <apex:outputPanel >
                    <apex:commandButton value="{!$Label.send}" rendered="{!abOptIn}" onclick="return submitSend();" ondblclick="return submitSend();" onmouseover="callSetTestPercentage()" action="{!abSendWasPressed}" style="background:#ff993f;color:white"/>
                    <apex:commandButton value="{!$Label.send}" disabled="true" rendered="{!NOT( abOptIn )}" />
                    <apex:commandButton value="{!$Label.cancel}" action="{!cancel}" />
                  </apex:outputPanel>
                </apex:pageBlockSectionItem>
              </apex:pageBlockSection>
            </apex:pageBlock>
      </apex:facet>
    </apex:actionStatus>
    <apex:composition template="et4ae5__etFooter" />
  </apex:form>
  <script type="text/javascript">
    var j$ = jQuery.noConflict();
    // Identify triggerable elements.
    var fsEmail = jQuery('[id$=fromSelectorEmail]');
    var fsSC = jQuery('[id$=fromSelectorSC]');
    var fsImme = jQuery('[id$=fromSelectorIm]');
    var fsDaTi = jQuery('[id$=fromSelectorDT]');
    var abTest = jQuery('[id$=abTestDiv]');
    var selectedABLabel = '[id$=abSubjectOn]';
    var abArray = ['abEmailOn', 'abEmailOff', 'abSubjectOn', 'abSubjectOff', 'abFromOn', 'abFromOff', 'abDateOn', 'abDateOff', 'abEmailCircleA',
    'abEmailCircleB',
    'abSubjectCircleA', 'abSubjectCircleB'
    ];
    // Test A
    var fsEmailA = jQuery('[id$=fromSelectorEmailA]');
    var fsSCA = jQuery('[id$=fromSelectorSCA]');
    var fsImmeA = jQuery('[id$=fromSelectorImA]');
    var fsDaTiA = jQuery('[id$=fromSelectorDTA]');
    var abTestA = jQuery('[id$=abTestDivA]');
    var selectedABLabelA = '[id$=abSubjectOnA]';
    // Test B
    var fsEmailB = jQuery('[id$=fromSelectorEmailB]');
    var fsSCB = jQuery('[id$=fromSelectorSCB]');
    var fsImmeB = jQuery('[id$=fromSelectorImB]');
    var fsDaTiB = jQuery('[id$=fromSelectorDTB]');
    var abTestB = jQuery('[id$=abTestDivB]');
    var selectedABLabelB = '[id$=abSubjectOnB]';

    // Assign event actions.
    fsEmail.onclick = swapFromSource('');
    fsSC.onclick = swapFromSource('');
    fsImme.onclick = swapDateSource('');
    fsDaTi.onclick = swapDateSource('');

    // Test A Assign event actions.
    fsEmailA.onclick = swapFromSource('testA');
    fsSCA.onclick = swapFromSource('testA');

    // Test B Assign event actions.
    fsEmailB.onclick = swapFromSource('testB');
    fsSCB.onclick = swapFromSource('testB');

    var sendBtnEnabled = true;

    function submitSend()
    {
    if (sendBtnEnabled)
    {
    sendBtnEnabled = false;
    return true;
    }
    return false;
    }

    function swapDateSource(testType)
    {
    var idFromSelectorIm, idFromSelectorDT,
    idSchCalendar, idSendDateTime;

    j$ = jQuery.noConflict();
    if (testType === 'testA')
    {
    idFromSelectorIm = 'fromSelectorImA';
    idFromSelectorDT = 'fromSelectorDTA';
    idSchCalendar = 'schCalendarA';
    idSendDateTime = 'sendDateTimeA';
    }
    else if (testType === 'testB')
    {
    idFromSelectorIm = 'fromSelectorImB';
    idFromSelectorDT = 'fromSelectorDTB';
    idSchCalendar = 'schCalendarB';
    idSendDateTime = 'sendDateTimeB';
    }
    else
    {
    idFromSelectorIm = 'fromSelectorIm';
    idFromSelectorDT = 'fromSelectorDT';
    idSchCalendar = 'schCalendar';
    idSendDateTime = 'sendDateTime';
    }

    fsImme = jQuery('[id$=' + idFromSelectorIm + ']');
    fsDaTi = jQuery('[id$=' + idFromSelectorDT + ']');
    // Identify picklists.
    var SDT = jQuery('[id$=' + idSchCalendar + ']');
    var calChoice = jQuery('[id$=' + idSendDateTime + ']');

    // Disable both picklists.
    SDT.hide();

    if (jQuery('[id$=' + idFromSelectorDT + ']').is(':checked') == true)
    fsDaTi.attr("checked", "checked");
    if (jQuery('[id$=' + idFromSelectorDT + ']').is(':checked') == false && jQuery('[id$=' + idFromSelectorIm + ']').is(':checked') == false)
    {
    fsImme.attr("checked", "checked");
    }
    if (fsDaTi.is(":checked") == true)
    {
    SDT.show();
    isSSon();
    }
    else
    {
    calChoice.val(null);
    isSSoff();
    }

    checkSendEmailReadiness();
    //alert('fromList.disabled: ' + fromList.attr);
    //alert('scList.disabled: ' + scList.attr);
    }

    function swapFromSource(testType)
    {
    var idFromSelectorEmail, idFromSelectorSC, idFrom,
    idSendClassification, idFromPicklist, idScPicklist;

    if (testType === 'testA')
    {
    idFromSelectorEmail = 'fromSelectorEmailA';
    idFromSelectorSC = 'fromSelectorSCA';
    idFrom = 'fromA';
    idSendClassification = 'sendClassificationA';
    idFromPicklist = 'fromPicklistA';
    idScPicklist = 'scPicklistA';
    }
    else if (testType === 'testB')
    {
    idFromSelectorEmail = 'fromSelectorEmailB';
    idFromSelectorSC = 'fromSelectorSCB';
    idFrom = 'fromB';
    idSendClassification = 'sendClassificationB';
    idFromPicklist = 'fromPicklistB';
    idScPicklist = 'scPicklistB';
    }
    else
    {
    idFromSelectorEmail = 'fromSelectorEmail';
    idFromSelectorSC = 'fromSelectorSC';
    idFrom = 'from';
    idSendClassification = 'sendClassification';
    idFromPicklist = 'fromPicklist';
    idScPicklist = 'scPicklist';
    }

    fsEmail = jQuery('[id$=' + idFromSelectorEmail + ']');
    fsSC = jQuery('[id$=' + idFromSelectorSC + ']');
    // Identify picklists.
    var fromList = jQuery('[id$=' + idFrom + ']');
    var scList = jQuery('[id$=' + idSendClassification + ']');
    var fromOP = jQuery('[id$=' + idFromPicklist + ']');
    var scOP = jQuery('[id$=' + idScPicklist + ']');

    // Disable both picklists.
    if (fromList != null) fromList.attr("disabled", true);
    if (scList != null) scList.attr("disabled", true);
    fromOP.hide();
    scOP.hide();

    if (jQuery('[id$=' + idFromSelectorEmail + ']').is(':checked') == true || (jQuery('[id$=theHiddenInput1]').val() == "true" && jQuery('[id$=' +
    idFromSelectorSC + ']').is(':checked') == false))
    fsEmail.attr("checked", "checked");
    if (jQuery('[id$=' + idFromSelectorSC + ']').is(':checked') == true || (jQuery('[id$=theHiddenInput2]').val() == "true" && jQuery('[id$=' +
    idFromSelectorEmail + ']').is(':checked') == false))
    fsSC.attr("checked", "checked");
    if (fsEmail.is(":checked") == false && fsSC.is(":checked") == false)
    fsEmail.attr("checked", "checked");

    // Enable the correct picklist.
    if (fsEmail.is(":checked") == true)
    {
    if (scList != null) scList.val("");
    if (fromList != null) fromList.removeAttr("disabled");
    fromOP.show();
    }
    if (fsSC.is(":checked") == true)
    {
    if (fromList != null) fromList.val("");
    if (scList != null) scList.removeAttr("disabled");
    scOP.show();
    }
    }



    // Initial swap execution.
    swapFromSource('');
    swapFromSource('testA');
    swapFromSource('testB');
    swapDateSource('');

    function changeTargetAudience()
    {
    changeTargetAudienceJS(jQuery('[id$=fromSelectorEmail]').is(':checked'), jQuery('[id$=fromSelectorSC]').is(':checked'));
    }

    function changeBusinessUnit()
    {
    changeBusinessUnitJS(jQuery('[id$=fromSelectorEmail]').is(':checked'), jQuery('[id$=fromSelectorSC]').is(':checked'));
    }

    function showpopup()
    {
    fsEmail.attr("checked", "checked");
    fsImme.attr("checked", "checked");
    swapFromSource('');
    swapDateSource('');
    var scOP = jQuery('[id$=scPicklist]');
    scOP.hide();
    document.getElementById('opaque').style.display = 'block';
    var popUp = document.getElementById("popupcontent");
    popUp.style.display = "block";
    }

    function hidepopup()
    {
    fsEmail.attr("checked", "checked");
    fsImme.attr("checked", "checked");
    swapFromSource('');
    swapDateSource('');
    var scOP = jQuery('[id$=scPicklist]');
    scOP.hide();
    var popUp = document.getElementById("popupcontent");
    popUp.style.display = "none";
    document.getElementById('opaque').style.display = 'none';
    }
    function doReportFolderSearch()
    {
    searchServer(document.getElementById("folderSearch").value);
    }
    function doReportfolderSearchExc()
    {
    searchServerExc(document.getElementById("folderSearchExc").value);
    }
  </script>
  <!-- 
  <apex:stylesheet value="https://{!urlRoot}.exacttarget.com/FuelUX/css/fuel-all.css" />
  <apex:stylesheet value="https://{!urlRoot}.exacttarget.com/FuelUX/css/ie8.css" />
  <apex:stylesheet value="https://{!urlRoot}.exacttarget.com/xpresscore/css/styles.css" />
  <div class="wrap" id="xpressDialogContent" style="position: relative; display: none;">
    <div class="modal-content" style="padding-bottom: 0px;">
      <div id="previewSendControl">
        <div id="subscriberPreviewLoader" />
        <div id="subscriberPreviewContainer" style="visibility: hidden;">
          <div id="subscriberPreviewNotification" style="height: 39px;" />
          <div id="selectSubscriberRegion">
            <div class="subscriber-preview-section" id="selectSubscriber">
              <table class="subscriber-selection-container">
                <tr id="subscriber-selection-container-row">
                  <th>
                    <span class="fuel-label"> {!$label.msg0023} </span>
                    &nbsp;
                  </th>
                  <td>
                    <button id="prevBtn" class="fuel-button-small">&lt;</button>
                  </td>
                  <td>
                    <div id="subScroller" />
                    <div id="subScrollerResults" style="overflow-y: scroll; overflow-x: hidden; z-index: 100; background-color: #fff; position: absolute; width: 298px; height: 150px; border: 1px solid black; display: none;"
                                        />
                  </td>
                  <td>
                    <button id="nextBtn" class="fuel-button-small">&gt;</button>
                  </td>
                </tr>
              </table>
              <div id="emailTypeSelector" />
            </div>
            <div class="subscriber-preview-section fuel-editor-canvas-layout modal-wrap" style="margin: 5px auto; text-align: center;" id="subscriberPreviewImageContainer">
              <div id="previewIframeContainer">
                <iframe id="previewHTMLIframe" frameborder="0" style="overflow-y: auto; height: 350px; width: 920px;" />
              </div>
            </div>
            <div class="subscriber-preview-section fuel-block" id="subscriberPreviewTextTrayContainer">
              <span id="subscriberPreviewTestEmails" class="fuel-label">
                {!$label.sndTstEmTo}
              </span>
              <div class="subscriber-preview-text-tray" id="subscriberPreviewTextTray">
                <div id="subscriberPreviewEmails" style="width: 98%; margin: inherited inherited 10px inherited;" />
                <button type="button" style="display: block; margin: 0px;" id="testSend" class="fuel-button-primary">
                  {!$label.testSend}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script type="text/javascript" src="https://app.s1.qa1.exacttarget.com/FuelUX/js/fuel-loader.js" />
  <script type="text/javascript" src="../../soap/ajax/27.0/connection.js" />
  <script type="text/javascript">
    var base64 = {};
    base64.PADCHAR = '=';
    base64.ALPHA = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';

    base64.makeDOMException = function ()
    {
    // sadly in FF,Safari,Chrome you can't make a DOMException
    var e, tmp;

    try
    {
    return new DOMException(DOMException.INVALID_CHARACTER_ERR);
    }
    catch (tmp)
    {
    // not available, just passback a duck-typed equiv
    // https://developer.mozilla.org/en/Core_JavaScript_1.5_Reference/Global_Objects/Error
    // https://developer.mozilla.org/en/Core_JavaScript_1.5_Reference/Global_Objects/Error/prototype
    var ex = new Error("DOM Exception 5");

    // ex.number and ex.description is IE-specific.
    ex.code = ex.number = 5;
    ex.name = ex.description = "INVALID_CHARACTER_ERR";

    // Safari/Chrome output format
    ex.toString = function ()
    {
    return 'Error: ' + ex.name + ': ' + ex.message;
    };
    return ex;
    }
    }

    base64.getbyte64 = function (s, i)
    {
    // This is oddly fast, except on Chrome/V8.
    //  Minimal or no improvement in performance by using a
    //   object with properties mapping chars to value (eg. 'A': 0)
    var idx = base64.ALPHA.indexOf(s.charAt(i));
    if (idx === -1)
    {
    throw base64.makeDOMException();
    }
    return idx;
    }

    base64.decode = function (s)
    {
    // convert to string
    s = '' + s;
    var getbyte64 = base64.getbyte64;
    var pads, i, b10;
    var imax = s.length
    if (imax === 0)
    {
    return s;
    }

    if (imax % 4 !== 0)
    {
    throw base64.makeDOMException();
    }

    pads = 0
    if (s.charAt(imax - 1) === base64.PADCHAR)
    {
    pads = 1;
    if (s.charAt(imax - 2) === base64.PADCHAR)
    {
    pads = 2;
    }
    // either way, we want to ignore this last block
    imax -= 4;
    }

    var x = [];
    for (i = 0; i < imax; i += 4)
            {
                b10 = (getbyte64(s, i) << 18) | (getbyte64(s, i + 1) << 12) |
                    (getbyte64(s, i + 2) << 6) | getbyte64(s, i + 3);
                x.push(String.fromCharCode(b10 >> 16, (b10 >> 8) & 0xff, b10 & 0xff));
            }

            switch (pads)
            {
            case 1:
                b10 = (getbyte64(s, i) << 18) | (getbyte64(s, i + 1) << 12) | (getbyte64(s, i + 2) << 6);
                x.push(String.fromCharCode(b10 >> 16, (b10 >> 8) & 0xff));
                break;
            case 2:
                b10 = (getbyte64(s, i) << 18) | (getbyte64(s, i + 1) << 12);
                x.push(String.fromCharCode(b10 >> 16));
                break;
            }
            return x.join('');
        }

        base64.getbyte = function (s, i)
        {
            var x = s.charCodeAt(i);
            if (x > 255)
            {
                throw base64.makeDOMException();
            }
            return x;
        }

        base64.encode = function (s)
        {
            if (arguments.length !== 1)
            {
                throw new SyntaxError("Not enough arguments");
            }
            var padchar = base64.PADCHAR;
            var alpha = base64.ALPHA;
            var getbyte = base64.getbyte;

            var i, b10;
            var x = [];

            // convert to string
            s = '' + s;

            var imax = s.length - s.length % 3;

            if (s.length === 0)
            {
                return s;
            }
            for (i = 0; i < imax; i += 3)
            {
                b10 = (getbyte(s, i) << 16) | (getbyte(s, i + 1) << 8) | getbyte(s, i + 2);
                x.push(alpha.charAt(b10 >> 18));
                x.push(alpha.charAt((b10 >> 12) & 0x3F));
                x.push(alpha.charAt((b10 >> 6) & 0x3f));
                x.push(alpha.charAt(b10 & 0x3f));
            }
            switch (s.length - imax)
            {
            case 1:
                b10 = getbyte(s, i) << 16;
                x.push(alpha.charAt(b10 >> 18) + alpha.charAt((b10 >> 12) & 0x3F) +
                    padchar + padchar);
                break;
            case 2:
                b10 = (getbyte(s, i) << 16) | (getbyte(s, i + 1) << 8);
                x.push(alpha.charAt(b10 >> 18) + alpha.charAt((b10 >> 12) & 0x3F) +
                    alpha.charAt((b10 >> 6) & 0x3f) + padchar);
                break;
            }
            return x.join('');
        }

        require([
                'fuel-jquery',
                'fuel-controls',
                'button'
            ],

            function ()
            {
                subscribers = (function ()
                {
                    var subs = [],
                        curIdx = 0,
                        curSub = {},
                        cacheHistory = [],

                        add = function (sub)
                        {
                            subs.push(sub);
                        },

                        clear = function ()
                        {
                            curSub = null;
                            curIdx = 0;
                            subs = [];
                        },

                        clearPreviewCache = function ()
                        {
                            for (var i = 0; i < subs.length; i++)
                            {
                                subs[i].htmlBody = null;
                                subs[i].textBody = null;
                            }
                        },

                        current = function ()
                        {
                            return curSub;
                        },

                        currentIndex = function ()
                        {
                            return curIdx;
                        },

                        getCount = function ()
                        {
                            return subs.length || 0;
                        },

                        next = function ()
                        {
                            if (subs.length != 1)
                            {
                                if (subs.length - 1 != curIdx)
                                {
                                    curIdx++;
                                }
                                else
                                {
                                    curIdx = 0;
                                }

                                select();

                                return curSub;
                            }
                        },

                        maintainCache = function ()
                        {
                            if (curSub !== undefined)
                            {
                                var existingIdx = cacheHistory.indexOf(curIdx);
                                if (existingIdx != -1)
                                {
                                    // Remove the index if it already exists
                                    cacheHistory.splice(existingIdx, 1);
                                }
                                cacheHistory.push(curIdx);
                            }

                            if (cacheHistory.length > 10)
                            {
                                // Clear the first array entry - it's the oldest
                                var idx = cacheHistory.shift();
                                subs[idx].htmlBody = null;
                                subs[idx].textBody = null;
                            }
                        },

                        previous = function ()
                        {
                            if (subs.length != 1)
                            {
                                if (curIdx != 0)
                                {
                                    curIdx--;
                                }
                                else
                                {
                                    curIdx = subs.length - 1;
                                }

                                select();

                                return curSub;
                            }
                        },

                        select = function (idx)
                        {
                            if (idx !== undefined)
                            {
                                curIdx = idx;
                            }

                            curSub = subs[curIdx];
                            maintainCache();
                        };

                    // Expose public methods
                    return {
                        add: add,
                        clearPreviewCache: clearPreviewCache,
                        clear: clear,
                        current: current,
                        currentIndex: currentIndex,
                        getCount: getCount,
                        next: next,
                        previous: previous,
                        select: select
                    };
                }());

                subscriberPreview = (function ()
                {
                    // Defined by the environment's App Center app
                    // PROD
                    var appId = '4ecb7b93-1ded-4319-8e9d-991ca63025ae',

                        // Enum
                        PreviewStates = {
                            INIT: 0,
                            SYNC: 1,
                            CHECK_SYNC: 2,
                            RETRIEVE: 3,
                            SELECT: 4
                        },

                        // Locals
                        // Variables prefixed with 'd' are decoded
                        // Variables prefixed with 'e' are encoded
                        dDeGuid = '',
                        eDeGuid = '',
                        eSyncSubId = '',
                        emailId = 0,
                        isInitialPreview = true,
                        integrationVersion = '5.0',
                        maxSubs = 250,
                        objectId = '{!dspObjectId}',
                        objectType = '{!dspObjectType}',
                        sfNamespace = 'et4ae5',
                        state = PreviewStates.INIT,
                        stopWorking = false,
                        legacyToken = '{!dspLegacyToken}',
                        accessToken = '{!dspAccessToken}',
                        syncRequest =
                        '{"isOneTime":true,"source":{"salesForce":{"version":"5.0","sourceList":{"campaigns":[{"campaignId":701i0000000PtwdAAC,"name":"Test Campaign"}]},"properties":[{"name":"SubscriberRetentionPeriod","value":"1"},{"name":"ThresholdCount","value":"250"}]}}}',


                        // Controls
                        btnNext = {},
                        btnPrev = {},
                        btnTestSend = {},
                        control = {},
                        emailTypeSelector = {},
                        iframe = {},
                        notifier = {},
                        previewLoadingIcon = {},
                        subSelector = {},

                        allParamsValid = function ()
                        {
                            var invalidParam = '';
                            var detailedMsg = '';
                            if (emailId === undefined || emailId <= 0)
    {
    invalidParam = '{!$label.emailId}';
    }
    if (invalidParam.length > 0)
    {
    showErrorMessage("{!$label.invalid} " + invalidParam + " {!$label.provided}. " + detailedMsg);
    return false;
    }

    return true;
    },

    checkSyncSubscribers = function ()
    {
    state = PreviewStates.CHECK_SYNC;
    // Requires encoded sync subscriber id
    Fuel.ajax(
    {
    url: Fuel.endpoints.Rest + 'beta/integration/subscriber/synchronization/' + eSyncSubId,
    dataType: "json",
    contentType: "application/json",
    type: "GET",
    cache: false,
    success: function (response)
    {
    if (!stopWorking)
    {
    if (response.syncStatus.toLowerCase() === 'errored')
    {
    showErrorMessage("{!$label.msg0069}");
    }
    else if (response.syncStatus.toLowerCase() !== 'completed')
    {
    setTimeout(function ()
    {
    checkSyncSubscribers();
    }, 5000);
    }
    else
    {
    eDeGuid = response.customObject.objectId;
    dDeGuid = decodeGuid(eDeGuid);
    retrieveSubscribers();
    }
    }
    },
    error: function ()
    {
    showErrorMessage("{!$label.msg0069}");
    toggleSyncLoadingIcon('hide');
    }
    });
    },

    clearPreview = function ()
    {
    iframe.contents().find('body').html('');
    },

    closeDialog = function ()
    {
    // Reinitialize some of the dialog controls
    stopWorking = true;
    clearPreview();
    subscribers.select(0);
    },

    decodeGuid = function (guid)
    {
    // Decodes a REST encoded GUID
    var result = base64.decode(guid);
    var parts = result.split(':');
    var value = parts[0] + '==';
    value = value.replace(/_/g, '/').replace(/-/g, '+');
    result = base64.decode(value);

    var data = result.split("");
    var copy = data.slice(0);
    data[0] = copy[3];
    data[1] = copy[2];
    data[2] = copy[1];
    data[3] = copy[0];
    data[4] = copy[5];
    data[5] = copy[4];
    data[6] = copy[7];
    data[7] = copy[6];

    var guid = [];
    for (var i = 0; i < data.length; i++)
                            {
                                if (i == 4 || i == 6 || i == 8 || i == 10) guid.push("-");
                                var b = data[i].charCodeAt(0).toString(16);
                                if (b.length == 1) b = "0" + b;
                                guid.push(b);
                            }
                            return guid.join("");
                        },

                        determineEmailType = function (htmlBody, textBody, selectedItem)
                        {
                            if (htmlBody.search('</body>') === -1)
    {
    emailTypeSelector.fuelButtonSet('selectButton', 'Text');
    emailTypeSelector.fuelButtonSet('setDisabled');
    selectedItem.value = 'text';

    showInfoMessage("{!$label.note}:", " {!$label.msg0024}");
    }
    else
    {
    showInfoMessage("{!$label.note}:", " {!$label.msg0045}");
    }
    },

    emailTypeSelected = function (evt, item)
    {
    clearPreview();
    var curSub = subscribers.current();

    if (item.value === 'html')
    {
    if (curSub.htmlBody === undefined)
    {
    // This should only happen if an error occurred; attempt a getPreview again
    selectSubscriber();
    }
    else
    {
    iframe.contents().find('body').html(subscribers.current().htmlBody);
    }
    }
    else if (item.value === 'text')
    {
    if (curSub.textBody === undefined)
    {
    // This should only happen if an error occurred; attempt a getPreview again
    selectSubscriber();
    }
    else
    {
    iframe.contents().find('body').html('<pre>' + subscribers.current().textBody + '</pre>');
    }
    }
    },

    getPreview = function (options)
    {
    // Get preview
    Fuel.ajax($.extend(
    {
    url: Fuel.endpoints.FuelAPI + 'guide/v1/emails/' + emailId + '/dataExtension/' + dDeGuid + '/contacts/key:' +
    subscribers.current().subscriberKey + '/preview',
    dataType: "json",
    type: "POST",
    cache: false,
    useFuel2Token: true
    }, options));
    },

    hideMessage = function (el)
    {
    var element = el || notifier;
    element.fuelNotification('hide');
    // Need to destroy the msg to make it go away
    element.fuelNotification('destroy');
    },

    hideResults = function (e)
    {
    var qry = $(e.target);
    if (!qry.closest('#subScroller').length && !qry.closest('#subScrollerResults').length)
    {
    $('#subScrollerResults').hide();
    }
    },

    init = function ()
    {
    // Do one-time initialization here
    control = $('#previewSendControl');
    notifier = $('#subscriberPreviewNotification');
    iframe = $('#previewHTMLIframe');
    emailTypeSelector = $('#emailTypeSelector');
    previewLoadingIcon = $('#subscriberPreviewImageContainer');
    subSelector = $('#subScroller');
    btnTestSend = $('#testSend');
    btnPrev = $('#prevBtn');
    btnNext = $('#nextBtn');

    control.click(hideResults);
    btnTestSend.click(sendTestEmail);
    btnPrev.click(previousSubscriber);
    btnNext.click(nextSubscriber);

    render();
    accessToken = jQuery("[id$=dspAccessToken]").val();
    legacyToken = jQuery("[id$=dspLegacyToken]").val();
    initFuel();
    },

    initEmailTypeSelector = function ()
    {
    emailTypeSelector.fuelButtonSet('destroy');
    var emailTypeButtons = [
    {
    "name": "HTML",
    "value": "html",
    "selected": true
    },
    {
    "name": "Text",
    "value": "text"
    }];
    emailTypeSelector.fuelButtonSet(
    {
    items: emailTypeButtons,
    onitemselected: emailTypeSelected
    });
    emailTypeSelector.fuelButtonSet('removeDisabled');
    },

    initFuel = function ()
    {
    // Retrieve the URL to use based on SF Config
    sforce.connection.sessionId = '{!GETSESSIONID()}';
    var restFieldName = sfNamespace + '__Root_Rest_API_URL__c';
    var configObjName = sfNamespace + '__Configuration__c';
    var config = sforce.connection.query('SELECT ' + restFieldName + ' FROM ' + configObjName + ' LIMIT 1');
    var url = config.records[restFieldName];

    url = url[url.length - 1] != '/' ? url + '/' : url;
    var baseUrl = url.replace('rest', '{!urlRoot}');
    var fuelApi = 'https://www.exacttargetapis.com/';
    var fuelAuthApi = 'https://auth.exacttargetapis.com/';
    // TODO: Move the auth URL to the SF Config
    if (baseUrl.indexOf('qa1') > 0)
    {
    fuelApi = 'https://qa.exacttargetapis.com/';
    fuelAuthApi = 'https://auth-qa1s1.exacttargetapis.com/';
    }
    else if (baseUrl.indexOf('qa2') > 0)
    {
    fuelApi = 'https://qa.exacttargetapis.com/';
    fuelAuthApi = 'https://auth-qa2s1.exacttargetapis.com/';
    }

    var endpoints = {
    FuelUX: baseUrl + 'FuelUX/1.8/',
    Platform: baseUrl,
    Rest: baseUrl + 'rest/',
    TokenRefresh: fuelAuthApi + 'v1/requestToken?legacy=1',
    XpressCore: baseUrl + 'XpressCore/',
    FuelAPI: fuelApi,
    FuelAuthAPI: fuelAuthApi
    };

    Fuel.init(
    {
    appId: appId,
    endpoints: endpoints,
    TOKENS:
    {
    legacyToken: legacyToken,
    accessToken: accessToken
    }
    });

    // Override the Fuel OAuth refresh call
    Fuel.oAuth.refresh = refreshOAuthToken;
    },

    nextSubscriber = function ()
    {
    if (subscribers.getCount() > 0)
    {
    subscribers.next();
    selectSubscriber();
    }
    },

    previousSubscriber = function ()
    {
    if (subscribers.getCount() > 0)
    {
    subscribers.previous();
    selectSubscriber();
    }
    },

    populateSubscribers = function (response)
    {
    try
    {
    var results = $('#subScrollerResults'),
    result;
    for (i in response.entry)
    {
    if (stopWorking)
    return;

    var subKeyField = $.grep(response.entry[i].customObjectData, function (e)
    {
    return e.name.toLowerCase() === "subscriberkey";
    });
    var emailField = $.grep(response.entry[i].customObjectData, function (e)
    {
    return e.name.toLowerCase() === "emailaddress";
    });

    if (subKeyField.length > 0)
    {
    response.entry[i].subscriberKey = subKeyField[0].value;
    }

    if (emailField.length > 0)
    {
    response.entry[i].emailAddress = emailField[0].value;
    }

    subscribers.add(response.entry[i]);
    result = $('<div id="' + i + '"></div>').html(response.entry[i].emailAddress);
    result.click(function ()
    {
    var selectedId = parseInt(this.id);
    if (subscribers.currentIndex() != selectedId)
    {
    subscribers.select(selectedId);
    selectSubscriber();
    }
    results.hide();
    });

    result.mouseover(function ()
    {
    $(this).css("background-color", "#98C9F4");
    });

    result.mouseout(function ()
    {
    $(this).css("background-color", "#FFFFFF");
    });

    results.append(result);
    }

    toggleSyncLoadingIcon('hide');

    if (subscribers.getCount() > 0)
    {
    subscribers.select(0);
    selectSubscriber();
    }
    else
    {
    results.append($("<div>{!$label.noDataFnd}</div>")).show();
    emailTypeSelector.fuelButtonSet('setDisabled');
    showInfoMessage("{!$label.msg0029}", " {!$label.msg0041}");
    toggleSyncLoadingIcon('hide');
    }
    }
    catch (e)
    {
    showErrorMessage("{!$label.msg0066} - " + e.message);
    toggleSyncLoadingIcon('hide');
    }
    },

    refreshOAuthToken = function (callback)
    {
    // In order to do this securely, need to implement refresh token on server side
    showErrorMessage("{!$label.prevExpd}");
    }

    render = function ()
    {
    // One time control inits & CSS tweaks needed to make the page look right.
    subSelector.fuelInput(
    {
    label: '',
    placeholder: '{!$Label.emailAddr}',
    width: 300
    }).click(showResults);
    subSelector.find('input').css('width', '270px');
    $('div .fuel-input-wrap').css('margin-bottom', '0px')
    $('#subscriberPreviewEmails').fuelInput(
    {
    label: '',
    placeholder: '{!$Label.emailAddr}',
    width: 600
    });
    // Remove the max length, then limit the number of recipients of we wish in sendTestEmail
    $('#subscriberPreviewEmails').find('input').removeAttr('maxlength')

    initEmailTypeSelector();

    $('#subscriberPreviewTextTrayContainer').css('visibility', 'inherit');
    },

    retrieveSubscribers = function ()
    {
    state = PreviewStates.RETRIEVE;
    if (stopWorking)
    return;

    // Requires an encoded data extension id
    Fuel.ajax(
    {
    url: Fuel.endpoints.Rest + 'beta/object/' + eDeGuid + '/data/?$sort=subscriberKey&$top=' + maxSubs,
    dataType: "json",
    type: "GET",
    cache: false,
    success: function (response, textStatus, xhr)
    {
    populateSubscribers(response);
    },
    error: function (data)
    {
    showErrorMessage("{!$label.msg0067}");
    toggleSyncLoadingIcon('hide');
    }
    });
    },

    selectSubscriber = function ()
    {
    state = PreviewStates.SELECT;
    try
    {
    togglePreviewLoadingIcon('show');
    var curSub = subscribers.current();

    subSelector.fuelInput('setValue', curSub.emailAddress);

    var selectedItems = emailTypeSelector.fuelButtonSet('getSelectedItems')
    var selectedItem = selectedItems.length > 0 ? selectedItems[0] : '';
    // If we have cache for the current sub, use it.
    if (selectedItem.value === 'html' && curSub.htmlBody)
    {
    iframe.contents().find('body').html(curSub.htmlBody);
    togglePreviewLoadingIcon('hide');
    }
    else if (selectedItem.value === 'text' && curSub.textBody)
    {
    iframe.contents().find('body').html('<pre>' + curSub.textBody + '</pre>');
    togglePreviewLoadingIcon('hide');
    }
    else
    {
    // No cache, get the preview
    getPreview(
    {
    error: function (data)
    {
    showErrorMessage("{!$label.msg0068}");
    clearPreview();
    // Do this so the info message will re-pop since an error message should be shown
    isInitialPreview = true;
    togglePreviewLoadingIcon('hide');
    },
    success: function (data)
    {
    var htmlView = $.grep(data.message.views, function (e)
    {
    return e.contentType.toLowerCase() === 'vnd.exacttarget.message.email.htmlbody';
    });
    var textView = $.grep(data.message.views, function (e)
    {
    return e.contentType.toLowerCase() === 'vnd.exacttarget.message.email.textbody';
    });

    var htmlBody = '';
    if (htmlView.length > 0)
    {
    htmlBody = htmlView[0].content;
    }

    var textBody = '';
    if (textView.length > 0)
    {
    textBody = textView[0].content;
    }

    curSub.htmlBody = htmlBody;
    curSub.textBody = textBody;

    if (isInitialPreview)
    {
    // Sets the email type selector state & info message
    determineEmailType(htmlBody, textBody, selectedItem);
    isInitialPreview = false;
    }

    if (selectedItem.value === 'html')
    {
    iframe.contents().find('body').html(htmlBody);
    }
    else if (selectedItem.value === 'text')
    {
    iframe.contents().find('body').html('<pre>' + textBody + '</pre>');
    }

    togglePreviewLoadingIcon('hide');
    }
    });
    }
    }
    catch (e)
    {
    showErrorMessage("{!$label.msg0070} - " + e.message);
    toggleSyncLoadingIcon('hide');
    }
    },

    sendTestEmail = function ()
    {
    // Remove whitespace and replace commas with semi-colons for delimiter
    var testSendEmails = $('#subscriberPreviewEmails').find('input').val().replace(/\s+/g, '').replace(/,/g, ';').split(';');
    if (testSendEmails.length > 0 && testSendEmails[0].toLowerCase() != '{!$Label.emailAddr}')
    {
    var sendJson = {
    "emailID": emailId,
    "fromName": testSendEmails[0],
    "fromEmail": testSendEmails[0],
    "dataSource":
    {
    "contact": "key:" + subscribers.current().subscriberKey,
    "type": "DataExtension",
    "id": dDeGuid
    },
    "recipients": testSendEmails
    };

    Fuel.ajax(
    {
    url: Fuel.endpoints.FuelAPI + 'guide/v1/emails/preview/send',
    dataType: "json",
    contentType: "application/json",
    type: "POST",
    cache: false,
    useFuel2Token: true,
    data: JSON.stringify(sendJson),
    success: function (response, textStatus, xhr)
    {
    showSuccessMessage('{!$label.testEmSent}', ' {!$label.emSentTo} ' + testSendEmails.join(', ').replace(
    /, (?=[^,]*$)/, ' & ') + '.');
    },
    error: function (xhr, status, error)
    {
    showErrorMessage("{!$label.testSdFail}");
    }
    });
    }
    else
    {
    showErrorMessage("{!$label.msg0040}");
    }
    },

    setObjectId = function (id)
    {
    objectId = id;
    state = PreviewStates.SYNC;
    subscribers.clear();
    clearSubscribers();
    },

    setObjectType = function (type)
    {
    objectType = type;
    state = PreviewStates.SYNC;
    subscribers.clear();
    clearSubscribers();
    },

    setEmailId = function (id)
    {
    emailId = id;
    subscribers.clearPreviewCache();
    initEmailTypeSelector();

    isInitialPreview = true;
    hideMessage();

    // Add height back to the notification so it's considered in the dialog height when opened
    $('#subscriberPreviewNotification').css('height', '39px');
    },

    setSyncRequest = function (payload)
    {
    syncRequest = payload;
    state = PreviewStates.SYNC;
    subscribers.clear();
    clearSubscribers();
    },

    showDialog = function ()
    {
    accessToken = jQuery("[id$=dspAccessToken]").val();
    legacyToken = jQuery("[id$=dspLegacyToken]").val();
    stopWorking = false;
    initFuel();
    if (allParamsValid())
    {
    // Determine the path to go down based on "state"
    switch (state)
    {
    case PreviewStates.CHECK_SYNC:
    checkSyncSubscribers();
    break;

    case PreviewStates.RETRIEVE:
    retrieveSubscribers();
    break;

    case PreviewStates.SELECT:
    selectSubscriber();
    break;

    default:
    toggleSyncLoadingIcon('show');
    syncSubscribers();
    break;
    }
    }

    $('#xpressDialogContent').fuelDialog(
    {
    title: "{!$label.sndPreview} - " + $('[id$=emailName]').text(),
    width: 960,
    footerButtonText: "{!$label.close}",
    showFooterLink: false,
    onbuttonclick: closeDialog,
    onxclick: closeDialog
    });

    $('#xpressDialogContent').fuelDialog('open');
    },

    showErrorMessage = function (msg)
    {
    showMessage("error", "{!$label.error}: ", msg);
    },

    showInfoMessage = function (boldMsgPortion, msg, el)
    {
    showMessage('informative', boldMsgPortion, msg, el);
    },

    showMessage = function (type, boldMsgPortion, msg, el)
    {
    var element = el || notifier;
    // Remove the div height when msg is hidden
    element.fuelNotification(
    {
    onhide: function ()
    {
    $('#subscriberPreviewNotification').css('height', '0px');
    }
    });

    $('#subscriberPreviewNotification').css('height', '39px');
    element.fuelNotification('show', type, boldMsgPortion, msg);
    },

    showResults = function ()
    {
    if ($('#subScrollerResults div').length)
    {
    $('#subScrollerResults').show();
    }
    },

    showSuccessMessage = function (boldMsgPortion, msg, el)
    {
    showMessage('information', boldMsgPortion, msg, el);
    },

    syncSubscribers = function ()
    {
    state = PreviewStates.SYNC;
    syncRequest = jQuery("[id$=syncPayloadOL]").val();
    if (stopWorking)
    return;
    Fuel.ajax(
    {
    url: Fuel.endpoints.Rest + 'beta/integration/subscriber/synchronization',
    dataType: "json",
    contentType: "application/json",
    type: "POST",
    cache: false,
    data: syncRequest,
    success: function (response)
    {
    eSyncSubId = response.id;
    checkSyncSubscribers();
    },
    error: function (xhr, status, error)
    {
    showErrorMessage("{!$label.syncSbFail}");
    toggleSyncLoadingIcon('hide');
    }
    });
    },

    togglePreviewLoadingIcon = function (state)
    {
    switch (state)
    {
    case "hide":
    $('#previewIframeContainer').fuelLoadingIconOnly('destroy');
    break;
    case "show":
    $('#previewIframeContainer').fuelLoadingIconOnly();
    break;
    }
    },

    toggleSyncLoadingIcon = function (state)
    {
    switch (state)
    {
    case "hide":
    control.fuelLoader('destroy');
    $('#subscriberPreviewContainer').css('visibility', 'visible');
    break;
    case "show":
    $('#subscriberPreviewContainer').css('visibility', 'hidden');
    control.fuelLoader(
    {
    annotated: "Sending data to ExactTarget..."
    });
    $('.fuel-loader-cell').css('vertical-align', 'middle');
    $('.fuel-loader-node').css('width', '95px');
    break;
    }
    };

    // Expose public methods
    return {
    init: init,
    showDialog: showDialog,
    setEmailId: setEmailId
    };
    }());

    subscriberPreview.init();
    });
  </script>-->
</apex:page>